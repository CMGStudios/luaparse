<!DOCTYPE html>

<html>
<head>
  <title>luaparse.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>luaparse.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* global exports:true, module:true, require:true, define:true, global:true */</span>

(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">root, name, factory</span>) </span>{
<span class="hljs-meta">  &#x27;use strict&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Used to determine if values are of the language type <code>Object</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> objectTypes = {
        <span class="hljs-string">&#x27;function&#x27;</span>: <span class="hljs-literal">true</span>
      , <span class="hljs-string">&#x27;object&#x27;</span>: <span class="hljs-literal">true</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Detect free variable <code>exports</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , freeExports = objectTypes[<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">exports</span>] &amp;&amp; <span class="hljs-built_in">exports</span> &amp;&amp; !<span class="hljs-built_in">exports</span>.nodeType &amp;&amp; <span class="hljs-built_in">exports</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Detect free variable <code>module</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , freeModule = objectTypes[<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span>] &amp;&amp; <span class="hljs-built_in">module</span> &amp;&amp; !<span class="hljs-built_in">module</span>.nodeType &amp;&amp; <span class="hljs-built_in">module</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Detect free variable <code>global</code>, from Node.js or Browserified code, and
use it as <code>window</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , freeGlobal = freeExports &amp;&amp; freeModule &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">global</span> === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; <span class="hljs-built_in">global</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Detect the popular CommonJS extension <code>module.exports</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , moduleExports = freeModule &amp;&amp; freeModule.exports === freeExports &amp;&amp; freeExports;

  <span class="hljs-comment">/* istanbul ignore else */</span>
  <span class="hljs-keyword">if</span> (freeGlobal &amp;&amp; (freeGlobal.global === freeGlobal ||
                     <span class="hljs-comment">/* istanbul ignore next */</span> freeGlobal.window === freeGlobal ||
                     <span class="hljs-comment">/* istanbul ignore next */</span> freeGlobal.self === freeGlobal)) {
    root = freeGlobal;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Some AMD build optimizers, like r.js, check for specific condition
patterns like the following:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/* istanbul ignore if */</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">&#x27;function&#x27;</span> &amp;&amp;
      <span class="hljs-comment">/* istanbul ignore next */</span> <span class="hljs-keyword">typeof</span> define.amd === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp;
      <span class="hljs-comment">/* istanbul ignore next */</span> define.amd) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>defined as an anonymous module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    define([<span class="hljs-string">&#x27;exports&#x27;</span>], factory);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>In case the source has been processed and wrapped in a define module use
the supplied <code>exports</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (freeExports &amp;&amp; moduleExports) factory(freeModule.exports);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>check for <code>exports</code> after <code>define</code> in case a build optimizer adds an
<code>exports</code> object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-comment">/* istanbul ignore else */</span> <span class="hljs-keyword">if</span> (freeExports &amp;&amp; freeModule) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>in Node.js or RingoJS v0.8.0+</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-comment">/* istanbul ignore else */</span>
    <span class="hljs-keyword">if</span> (moduleExports) factory(freeModule.exports);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>in RingoJS v0.7.0-</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> factory(freeExports);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>in a browser or Rhino</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> {
    factory((root[name] = {}));
  }
}(<span class="hljs-built_in">this</span>, <span class="hljs-string">&#x27;luaparse&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">exports</span></span>) </span>{
<span class="hljs-meta">  &#x27;use strict&#x27;</span>;

  <span class="hljs-built_in">exports</span>.version = <span class="hljs-string">&#x27;0.2.1&#x27;</span>;

  <span class="hljs-keyword">var</span> input, options, length, features, encodingMode;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Options can be set either globally on the parser object through
defaultOptions, or during the parse call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> defaultOptions = <span class="hljs-built_in">exports</span>.defaultOptions = {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Explicitly tell the parser when the input ends.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      wait: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Store comments as an array in the chunk object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">comments</span>: <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Track identifier scopes by adding an isLocal attribute to each
identifier-node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">scope</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Store location information on each syntax node as
<code>loc: { start: { line, column }, end: { line, column } }</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">locations</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Store the start and end character locations on each syntax node as
<code>range: [start, end]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">ranges</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>A callback which will be invoked when a syntax node has been completed.
The node which has been created will be passed as the only parameter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">onCreateNode</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>A callback which will be invoked when a new scope is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">onCreateScope</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>A callback which will be invoked when the current scope is destroyed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">onDestroyScope</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>A callback which will be invoked when a local variable is declared in the current scope.
The variable’s name will be passed as the only parameter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">onLocalDeclaration</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The version of Lua targeted by the parser (string; allowed values are
‘5.1’, ‘5.2’, ‘5.3’).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">luaVersion</span>: <span class="hljs-string">&#x27;5.1&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Encoding mode: how to interpret code units higher than U+007F in input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , <span class="hljs-attr">encodingMode</span>: <span class="hljs-string">&#x27;none&#x27;</span>
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encodeUTF8</span>(<span class="hljs-params">codepoint, highMask</span>) </span>{
    highMask = highMask || <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (codepoint &lt; <span class="hljs-number">0x80</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(codepoint);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (codepoint &lt; <span class="hljs-number">0x800</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(
        highMask | <span class="hljs-number">0xc0</span> |  (codepoint &gt;&gt;  <span class="hljs-number">6</span>)        ,
        highMask | <span class="hljs-number">0x80</span> | ( codepoint        &amp; <span class="hljs-number">0x3f</span>)
      );
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (codepoint &lt; <span class="hljs-number">0x10000</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(
        highMask | <span class="hljs-number">0xe0</span> |  (codepoint &gt;&gt; <span class="hljs-number">12</span>)        ,
        highMask | <span class="hljs-number">0x80</span> | ((codepoint &gt;&gt;  <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>),
        highMask | <span class="hljs-number">0x80</span> | ( codepoint        &amp; <span class="hljs-number">0x3f</span>)
      );
    } <span class="hljs-keyword">else</span> <span class="hljs-comment">/* istanbul ignore else */</span> <span class="hljs-keyword">if</span> (codepoint &lt; <span class="hljs-number">0x110000</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(
        highMask | <span class="hljs-number">0xf0</span> |  (codepoint &gt;&gt; <span class="hljs-number">18</span>)        ,
        highMask | <span class="hljs-number">0x80</span> | ((codepoint &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x3f</span>),
        highMask | <span class="hljs-number">0x80</span> | ((codepoint &gt;&gt;  <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>),
        highMask | <span class="hljs-number">0x80</span> | ( codepoint        &amp; <span class="hljs-number">0x3f</span>)
      );
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>TODO: Lua 5.4 allows up to six-byte sequences, as in UTF-8:1993</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toHex</span>(<span class="hljs-params">num, digits</span>) </span>{
    <span class="hljs-keyword">var</span> result = num.toString(<span class="hljs-number">16</span>);
    <span class="hljs-keyword">while</span> (result.length &lt; digits)
      result = <span class="hljs-string">&#x27;0&#x27;</span> + result;
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkChars</span>(<span class="hljs-params">rx</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{
      <span class="hljs-keyword">var</span> m = rx.exec(s);
      <span class="hljs-keyword">if</span> (!m)
        <span class="hljs-keyword">return</span> s;
      raise(<span class="hljs-literal">null</span>, errors.invalidCodeUnit, toHex(m[<span class="hljs-number">0</span>].charCodeAt(<span class="hljs-number">0</span>), <span class="hljs-number">4</span>).toUpperCase());
    };
  }

  <span class="hljs-keyword">var</span> encodingModes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><code>pseudo-latin1</code> encoding mode: assume the input was decoded with the latin1 encoding
WARNING: latin1 does <strong>NOT</strong> mean cp1252 here like in the bone-headed WHATWG standard;
it means true ISO/IEC 8859-1 identity-mapped to Basic Latin and Latin-1 Supplement blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">&#x27;pseudo-latin1&#x27;</span>: {
      <span class="hljs-attr">fixup</span>: checkChars(<span class="hljs-regexp">/[^\x00-\xff]/</span>),
      <span class="hljs-attr">encodeByte</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(value);
      },
      <span class="hljs-attr">encodeUTF8</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">codepoint</span>) </span>{
        <span class="hljs-keyword">return</span> encodeUTF8(codepoint);
      },
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>x-user-defined</code> encoding mode: assume the input was decoded with the WHATWG <code>x-user-defined</code> encoding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">&#x27;x-user-defined&#x27;</span>: {
      <span class="hljs-attr">fixup</span>: checkChars(<span class="hljs-regexp">/[^\x00-\x7f\uf780-\uf7ff]/</span>),
      <span class="hljs-attr">encodeByte</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
        <span class="hljs-keyword">if</span> (value &gt;= <span class="hljs-number">0x80</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(value | <span class="hljs-number">0xf700</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(value);
      },
      <span class="hljs-attr">encodeUTF8</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">codepoint</span>) </span>{
        <span class="hljs-keyword">return</span> encodeUTF8(codepoint, <span class="hljs-number">0xf700</span>);
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>none</code> encoding mode: disregard intrepretation of string literals, leave identifiers as-is</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">&#x27;none&#x27;</span>: {
      <span class="hljs-attr">discardStrings</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">fixup</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{
        <span class="hljs-keyword">return</span> s;
      },
      <span class="hljs-attr">encodeByte</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
      },
      <span class="hljs-attr">encodeUTF8</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">codepoint</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
      }
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>The available tokens expressed as enum flags so they can be checked with
bitwise operations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> EOF = <span class="hljs-number">1</span>, StringLiteral = <span class="hljs-number">2</span>, Keyword = <span class="hljs-number">4</span>, Identifier = <span class="hljs-number">8</span>
    , NumericLiteral = <span class="hljs-number">16</span>, Punctuator = <span class="hljs-number">32</span>, BooleanLiteral = <span class="hljs-number">64</span>
    , NilLiteral = <span class="hljs-number">128</span>, VarargLiteral = <span class="hljs-number">256</span>;

  <span class="hljs-built_in">exports</span>.tokenTypes = { <span class="hljs-attr">EOF</span>: EOF, <span class="hljs-attr">StringLiteral</span>: StringLiteral
    , <span class="hljs-attr">Keyword</span>: Keyword, <span class="hljs-attr">Identifier</span>: Identifier, <span class="hljs-attr">NumericLiteral</span>: NumericLiteral
    , <span class="hljs-attr">Punctuator</span>: Punctuator, <span class="hljs-attr">BooleanLiteral</span>: BooleanLiteral
    , <span class="hljs-attr">NilLiteral</span>: NilLiteral, <span class="hljs-attr">VarargLiteral</span>: VarargLiteral
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>As this parser is a bit different from luas own, the error messages
will be different in some situations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> errors = <span class="hljs-built_in">exports</span>.errors = {
      <span class="hljs-attr">unexpected</span>: <span class="hljs-string">&#x27;unexpected %1 \&#x27;%2\&#x27; near \&#x27;%3\&#x27;&#x27;</span>
    , <span class="hljs-attr">unexpectedEOF</span>: <span class="hljs-string">&#x27;unexpected symbol near \&#x27;&lt;eof&gt;\&#x27;&#x27;</span>
    , <span class="hljs-attr">expected</span>: <span class="hljs-string">&#x27;\&#x27;%1\&#x27; expected near \&#x27;%2\&#x27;&#x27;</span>
    , <span class="hljs-attr">expectedToken</span>: <span class="hljs-string">&#x27;%1 expected near \&#x27;%2\&#x27;&#x27;</span>
    , <span class="hljs-attr">unfinishedString</span>: <span class="hljs-string">&#x27;unfinished string near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">malformedNumber</span>: <span class="hljs-string">&#x27;malformed number near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">decimalEscapeTooLarge</span>: <span class="hljs-string">&#x27;decimal escape too large near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">invalidEscape</span>: <span class="hljs-string">&#x27;invalid escape sequence near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">hexadecimalDigitExpected</span>: <span class="hljs-string">&#x27;hexadecimal digit expected near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">braceExpected</span>: <span class="hljs-string">&#x27;missing \&#x27;%1\&#x27; near \&#x27;%2\&#x27;&#x27;</span>
    , <span class="hljs-attr">tooLargeCodepoint</span>: <span class="hljs-string">&#x27;UTF-8 value too large near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">unfinishedLongString</span>: <span class="hljs-string">&#x27;unfinished long string (starting at line %1) near \&#x27;%2\&#x27;&#x27;</span>
    , <span class="hljs-attr">unfinishedLongComment</span>: <span class="hljs-string">&#x27;unfinished long comment (starting at line %1) near \&#x27;%2\&#x27;&#x27;</span>
    , <span class="hljs-attr">ambiguousSyntax</span>: <span class="hljs-string">&#x27;ambiguous syntax (function call x new statement) near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">noLoopToBreak</span>: <span class="hljs-string">&#x27;no loop to break near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">labelAlreadyDefined</span>: <span class="hljs-string">&#x27;label \&#x27;%1\&#x27; already defined on line %2&#x27;</span>
    , <span class="hljs-attr">labelNotVisible</span>: <span class="hljs-string">&#x27;no visible label \&#x27;%1\&#x27; for &lt;goto&gt;&#x27;</span>
    , <span class="hljs-attr">gotoJumpInLocalScope</span>: <span class="hljs-string">&#x27;&lt;goto %1&gt; jumps into the scope of local \&#x27;%2\&#x27;&#x27;</span>
    , <span class="hljs-attr">cannotUseVararg</span>: <span class="hljs-string">&#x27;cannot use \&#x27;...\&#x27; outside a vararg function near \&#x27;%1\&#x27;&#x27;</span>
    , <span class="hljs-attr">invalidCodeUnit</span>: <span class="hljs-string">&#x27;code unit U+%1 is not allowed in the current encoding mode&#x27;</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h3 id="abstract-syntax-tree">Abstract Syntax Tree</h3>
<p>The default AST structure is inspired by the Mozilla Parser API but can
easily be customized by overriding these functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> ast = <span class="hljs-built_in">exports</span>.ast = {
      <span class="hljs-attr">labelStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">label</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;LabelStatement&#x27;</span>
        , <span class="hljs-attr">label</span>: label
      };
    }

    , <span class="hljs-attr">breakStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;BreakStatement&#x27;</span>
      };
    }

    , <span class="hljs-attr">gotoStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">label</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;GotoStatement&#x27;</span>
        , <span class="hljs-attr">label</span>: label
      };
    }

    , <span class="hljs-attr">returnStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ReturnStatement&#x27;</span>
        , <span class="hljs-string">&#x27;arguments&#x27;</span>: args
      };
    }

    , <span class="hljs-attr">ifStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">clauses</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IfStatement&#x27;</span>
        , <span class="hljs-attr">clauses</span>: clauses
      };
    }
    , <span class="hljs-attr">ifClause</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">condition, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IfClause&#x27;</span>
        , <span class="hljs-attr">condition</span>: condition
        , <span class="hljs-attr">body</span>: body
      };
    }
    , <span class="hljs-attr">elseifClause</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">condition, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ElseifClause&#x27;</span>
        , <span class="hljs-attr">condition</span>: condition
        , <span class="hljs-attr">body</span>: body
      };
    }
    , <span class="hljs-attr">elseClause</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ElseClause&#x27;</span>
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">whileStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">condition, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;WhileStatement&#x27;</span>
        , <span class="hljs-attr">condition</span>: condition
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">doStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;DoStatement&#x27;</span>
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">repeatStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">condition, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;RepeatStatement&#x27;</span>
        , <span class="hljs-attr">condition</span>: condition
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">localStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">variables, init</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;LocalStatement&#x27;</span>
        , <span class="hljs-attr">variables</span>: variables
        , <span class="hljs-attr">init</span>: init
      };
    }

    , <span class="hljs-attr">assignmentStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">variables, init</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;AssignmentStatement&#x27;</span>
        , <span class="hljs-attr">variables</span>: variables
        , <span class="hljs-attr">init</span>: init
      };
    }

    , <span class="hljs-attr">callStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">expression</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;CallStatement&#x27;</span>
        , <span class="hljs-attr">expression</span>: expression
      };
    }

    , <span class="hljs-attr">functionStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">identifier, parameters, isLocal, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FunctionDeclaration&#x27;</span>
        , <span class="hljs-attr">identifier</span>: identifier
        , <span class="hljs-attr">isLocal</span>: isLocal
        , <span class="hljs-attr">parameters</span>: parameters
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">forNumericStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">variable, start, end, step, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ForNumericStatement&#x27;</span>
        , <span class="hljs-attr">variable</span>: variable
        , <span class="hljs-attr">start</span>: start
        , <span class="hljs-attr">end</span>: end
        , <span class="hljs-attr">step</span>: step
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">forGenericStatement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">variables, iterators, body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ForGenericStatement&#x27;</span>
        , <span class="hljs-attr">variables</span>: variables
        , <span class="hljs-attr">iterators</span>: iterators
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">chunk</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">body</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;Chunk&#x27;</span>
        , <span class="hljs-attr">body</span>: body
      };
    }

    , <span class="hljs-attr">identifier</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;Identifier&#x27;</span>
        , <span class="hljs-attr">name</span>: name
      };
    }

    , <span class="hljs-attr">literal</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, value, raw</span>) </span>{
      type = (type === StringLiteral) ? <span class="hljs-string">&#x27;StringLiteral&#x27;</span>
        : (type === NumericLiteral) ? <span class="hljs-string">&#x27;NumericLiteral&#x27;</span>
        : (type === BooleanLiteral) ? <span class="hljs-string">&#x27;BooleanLiteral&#x27;</span>
        : (type === NilLiteral) ? <span class="hljs-string">&#x27;NilLiteral&#x27;</span>
        : <span class="hljs-string">&#x27;VarargLiteral&#x27;</span>;

      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: type
        , <span class="hljs-attr">value</span>: value
        , <span class="hljs-attr">raw</span>: raw
      };
    }

    , <span class="hljs-attr">tableKey</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, value</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;TableKey&#x27;</span>
        , <span class="hljs-attr">key</span>: key
        , <span class="hljs-attr">value</span>: value
      };
    }
    , <span class="hljs-attr">tableKeyString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, value</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;TableKeyString&#x27;</span>
        , <span class="hljs-attr">key</span>: key
        , <span class="hljs-attr">value</span>: value
      };
    }
    , <span class="hljs-attr">tableValue</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;TableValue&#x27;</span>
        , <span class="hljs-attr">value</span>: value
      };
    }


    , <span class="hljs-attr">tableConstructorExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fields</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;TableConstructorExpression&#x27;</span>
        , <span class="hljs-attr">fields</span>: fields
      };
    }
    , <span class="hljs-attr">binaryExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">operator, left, right</span>) </span>{
      <span class="hljs-keyword">var</span> type = (<span class="hljs-string">&#x27;and&#x27;</span> === operator || <span class="hljs-string">&#x27;or&#x27;</span> === operator) ?
        <span class="hljs-string">&#x27;LogicalExpression&#x27;</span> :
        <span class="hljs-string">&#x27;BinaryExpression&#x27;</span>;

      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: type
        , <span class="hljs-attr">operator</span>: operator
        , <span class="hljs-attr">left</span>: left
        , <span class="hljs-attr">right</span>: right
      };
    }
    , <span class="hljs-attr">unaryExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">operator, argument</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;UnaryExpression&#x27;</span>
        , <span class="hljs-attr">operator</span>: operator
        , <span class="hljs-attr">argument</span>: argument
      };
    }
    , <span class="hljs-attr">memberExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">base, indexer, identifier</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;MemberExpression&#x27;</span>
        , <span class="hljs-attr">indexer</span>: indexer
        , <span class="hljs-attr">identifier</span>: identifier
        , <span class="hljs-attr">base</span>: base
      };
    }

    , <span class="hljs-attr">indexExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">base, index</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IndexExpression&#x27;</span>
        , <span class="hljs-attr">base</span>: base
        , <span class="hljs-attr">index</span>: index
      };
    }

    , <span class="hljs-attr">callExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">base, args</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;CallExpression&#x27;</span>
        , <span class="hljs-attr">base</span>: base
        , <span class="hljs-string">&#x27;arguments&#x27;</span>: args
      };
    }

    , <span class="hljs-attr">tableCallExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">base, args</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;TableCallExpression&#x27;</span>
        , <span class="hljs-attr">base</span>: base
        , <span class="hljs-string">&#x27;arguments&#x27;</span>: args
      };
    }

    , <span class="hljs-attr">stringCallExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">base, argument</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;StringCallExpression&#x27;</span>
        , <span class="hljs-attr">base</span>: base
        , <span class="hljs-attr">argument</span>: argument
      };
    }

    , <span class="hljs-attr">comment</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, raw</span>) </span>{
      <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;Comment&#x27;</span>
        , <span class="hljs-attr">value</span>: value
        , <span class="hljs-attr">raw</span>: raw
      };
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Wrap up the node object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finishNode</span>(<span class="hljs-params">node</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Pop a <code>Marker</code> off the location-array and attach its location data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (trackLocations) {
      <span class="hljs-keyword">var</span> location = locations.pop();
      location.complete();
      location.bless(node);
    }
    <span class="hljs-keyword">if</span> (options.onCreateNode) options.onCreateNode(node);
    <span class="hljs-keyword">return</span> node;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> slice = <span class="hljs-built_in">Array</span>.prototype.slice
    , toString = <span class="hljs-built_in">Object</span>.prototype.toString
    ;

  <span class="hljs-keyword">var</span> indexOf = <span class="hljs-comment">/* istanbul ignore next */</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">array, element</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, length = array.length; i &lt; length; ++i) {
      <span class="hljs-keyword">if</span> (array[i] === element) <span class="hljs-keyword">return</span> i;
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  };

  <span class="hljs-comment">/* istanbul ignore else */</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.prototype.indexOf)
    indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">array, element</span>) </span>{
      <span class="hljs-keyword">return</span> array.indexOf(element);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Iterate through an array of objects and return the index of an object
with a matching property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">indexOfObject</span>(<span class="hljs-params">array, property, element</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, length = array.length; i &lt; length; ++i) {
      <span class="hljs-keyword">if</span> (array[i][property] === element) <span class="hljs-keyword">return</span> i;
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>A sprintf implementation using %index (beginning at 1) to input
arguments in the format string.</p>
<p>Example:</p>
<pre><code><span class="hljs-comment">// Unexpected function in token</span>
sprintf(<span class="hljs-string">&#x27;Unexpected %2 in %1.&#x27;</span>, <span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;function&#x27;</span>);</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sprintf</span>(<span class="hljs-params">format</span>) </span>{
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    format = format.replace(<span class="hljs-regexp">/%(\d)/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">match, index</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span> + args[index - <span class="hljs-number">1</span>] || <span class="hljs-comment">/* istanbul ignore next */</span> <span class="hljs-string">&#x27;&#x27;</span>;
    });
    <span class="hljs-keyword">return</span> format;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Polyfill for <code>Object.assign</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> assign = <span class="hljs-comment">/* istanbul ignore next */</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dest</span>) </span>{
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)
      , src, prop;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, length = args.length; i &lt; length; ++i) {
      src = args[i];
      <span class="hljs-keyword">for</span> (prop <span class="hljs-keyword">in</span> src)
        <span class="hljs-comment">/* istanbul ignore else */</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(src, prop)) {
          dest[prop] = src[prop];
        }
    }

    <span class="hljs-keyword">return</span> dest;
  };

  <span class="hljs-comment">/* istanbul ignore else */</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.assign)
    assign = <span class="hljs-built_in">Object</span>.assign;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h3 id="error-functions">Error functions</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-built_in">exports</span>.SyntaxError = <span class="hljs-built_in">SyntaxError</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>XXX: Eliminate this function and change the error type to be different from SyntaxError.
This will unfortunately be a breaking change, because some downstream users depend
on the error thrown being an instance of SyntaxError. For example, the Ace editor:
<a href="https://github.com/ajaxorg/ace/blob/4c7e5eb3f5d5ca9434847be51834a4e41661b852/lib/ace/mode/lua_worker.js#L55">https://github.com/ajaxorg/ace/blob/4c7e5eb3f5d5ca9434847be51834a4e41661b852/lib/ace/mode/lua_worker.js#L55</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixupError</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-comment">/* istanbul ignore if */</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.create)
      <span class="hljs-keyword">return</span> e;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(e, {
      <span class="hljs-string">&#x27;line&#x27;</span>: { <span class="hljs-string">&#x27;writable&#x27;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: e.line },
      <span class="hljs-string">&#x27;index&#x27;</span>: { <span class="hljs-string">&#x27;writable&#x27;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: e.index },
      <span class="hljs-string">&#x27;column&#x27;</span>: { <span class="hljs-string">&#x27;writable&#x27;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: e.column }
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h4 id="raise-an-exception">Raise an exception.</h4>
<p>Raise an exception by passing a token, a string format and its paramters.</p>
<p>The passed tokens location will automatically be added to the error
message if it exists, if not it will default to the lexers current
position.</p>
<p>Example:</p>
<pre><code><span class="hljs-comment">// [1:0] expected [ near (</span>
raise(token, <span class="hljs-string">&quot;expected %1 near %2&quot;</span>, <span class="hljs-string">&#x27;[&#x27;</span>, token.value);</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">raise</span>(<span class="hljs-params">token</span>) </span>{
    <span class="hljs-keyword">var</span> message = sprintf.apply(<span class="hljs-literal">null</span>, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>))
      , error, col;

    <span class="hljs-keyword">if</span> (token === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> token.line === <span class="hljs-string">&#x27;undefined&#x27;</span>) {
      col = index - lineStart + <span class="hljs-number">1</span>;
      error = fixupError(<span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(sprintf(<span class="hljs-string">&#x27;[%1:%2] %3&#x27;</span>, line, col, message)));
      error.index = index;
      error.line = line;
      error.column = col;
    } <span class="hljs-keyword">else</span> {
      col = token.range[<span class="hljs-number">0</span>] - token.lineStart;
      error = fixupError(<span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(sprintf(<span class="hljs-string">&#x27;[%1:%2] %3&#x27;</span>, token.line, col, message)));
      error.line = token.line;
      error.index = token.range[<span class="hljs-number">0</span>];
      error.column = col;
    }
    <span class="hljs-keyword">throw</span> error;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tokenValue</span>(<span class="hljs-params">token</span>) </span>{
    <span class="hljs-keyword">var</span> raw = input.slice(token.range[<span class="hljs-number">0</span>], token.range[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> (raw)
      <span class="hljs-keyword">return</span> raw;
    <span class="hljs-keyword">return</span> token.value;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h4 id="raise-an-unexpected-token-error">Raise an unexpected token error.</h4>
<p>Example:</p>
<pre><code><span class="hljs-comment">// expected &lt;name&gt; near &#x27;0&#x27;</span>
raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;name&gt;&#x27;</span>, token);</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">raiseUnexpectedToken</span>(<span class="hljs-params">type, token</span>) </span>{
    raise(token, errors.expectedToken, type, tokenValue(token));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h4 id="raise-a-general-unexpected-error">Raise a general unexpected error</h4>
<p>Usage should pass either a token object or a symbol string which was
expected. We can also specify a nearby token such as <eof>, this will
default to the currently active token.</p>
<p>Example:</p>
<pre><code><span class="hljs-comment">// Unexpected symbol &#x27;end&#x27; near &#x27;&lt;eof&gt;&#x27;</span>
unexpected(token);</code></pre><p>If there’s no token in the buffer it means we have reached <eof>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unexpected</span>(<span class="hljs-params">found</span>) </span>{
    <span class="hljs-keyword">var</span> near = tokenValue(lookahead);
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;undefined&#x27;</span> !== <span class="hljs-keyword">typeof</span> found.type) {
      <span class="hljs-keyword">var</span> type;
      <span class="hljs-keyword">switch</span> (found.type) {
        <span class="hljs-keyword">case</span> StringLiteral:   type = <span class="hljs-string">&#x27;string&#x27;</span>;      <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> Keyword:         type = <span class="hljs-string">&#x27;keyword&#x27;</span>;     <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> Identifier:      type = <span class="hljs-string">&#x27;identifier&#x27;</span>;  <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> NumericLiteral:  type = <span class="hljs-string">&#x27;number&#x27;</span>;      <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> Punctuator:      type = <span class="hljs-string">&#x27;symbol&#x27;</span>;      <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> BooleanLiteral:  type = <span class="hljs-string">&#x27;boolean&#x27;</span>;     <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> NilLiteral:
          <span class="hljs-keyword">return</span> raise(found, errors.unexpected, <span class="hljs-string">&#x27;symbol&#x27;</span>, <span class="hljs-string">&#x27;nil&#x27;</span>, near);
        <span class="hljs-keyword">case</span> EOF:
          <span class="hljs-keyword">return</span> raise(found, errors.unexpectedEOF);
      }
      <span class="hljs-keyword">return</span> raise(found, errors.unexpected, type, tokenValue(found), near);
    }
    <span class="hljs-keyword">return</span> raise(found, errors.unexpected, <span class="hljs-string">&#x27;symbol&#x27;</span>, found, near);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="lexer">Lexer</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>The lexer, or the tokenizer reads the input string character by character
and derives a token left-right. To be as efficient as possible the lexer
prioritizes the common cases such as identifiers. It also works with
character codes instead of characters as string comparisons was the
biggest bottleneck of the parser.</p>
<p>If <code>options.comments</code> is enabled, all comments encountered will be stored
in an array which later will be appended to the chunk object. If disabled,
they will simply be disregarded.</p>
<p>When the lexer has derived a valid token, it will be returned as an object
containing its value and as well as its position in the input string (this
is always enabled to provide proper debug messages).</p>
<p><code>lex()</code> starts lexing and returns the following token in the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> index
    , token
    , previousToken
    , lookahead
    , comments
    , tokenStart
    , line
    , lineStart;

  <span class="hljs-built_in">exports</span>.lex = lex;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lex</span>(<span class="hljs-params"></span>) </span>{
    skipWhiteSpace();</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Skip comments beginning with –</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> (<span class="hljs-number">45</span> === input.charCodeAt(index) &amp;&amp;
           <span class="hljs-number">45</span> === input.charCodeAt(index + <span class="hljs-number">1</span>)) {
      scanComment();
      skipWhiteSpace();
    }
    <span class="hljs-keyword">if</span> (index &gt;= length) <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span> : EOF
      , <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;&lt;eof&gt;&#x27;</span>
      , <span class="hljs-attr">line</span>: line
      , <span class="hljs-attr">lineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [index, index]
    };

    <span class="hljs-keyword">var</span> charCode = input.charCodeAt(index)
      , next = input.charCodeAt(index + <span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Memorize the range index where the token begins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tokenStart = index;
    <span class="hljs-keyword">if</span> (isIdentifierStart(charCode)) <span class="hljs-keyword">return</span> scanIdentifierOrKeyword();

    <span class="hljs-keyword">switch</span> (charCode) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">39</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">34</span>: <span class="hljs-comment">// &#x27;&quot;</span>
        <span class="hljs-keyword">return</span> scanStringLiteral();

      <span class="hljs-keyword">case</span> <span class="hljs-number">48</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">49</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">50</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">51</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">52</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">53</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-number">54</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">55</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">56</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">57</span>: <span class="hljs-comment">// 0-9</span>
        <span class="hljs-keyword">return</span> scanNumericLiteral();

      <span class="hljs-keyword">case</span> <span class="hljs-number">46</span>: <span class="hljs-comment">// .</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>If the dot is followed by a digit it’s a float.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (isDecDigit(next)) <span class="hljs-keyword">return</span> scanNumericLiteral();
        <span class="hljs-keyword">if</span> (<span class="hljs-number">46</span> === next) {
          <span class="hljs-keyword">if</span> (<span class="hljs-number">46</span> === input.charCodeAt(index + <span class="hljs-number">2</span>)) <span class="hljs-keyword">return</span> scanVarargLiteral();
          <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;..&#x27;</span>);
        }
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;.&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">61</span>: <span class="hljs-comment">// =</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-number">61</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;==&#x27;</span>);
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;=&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">62</span>: <span class="hljs-comment">// &gt;</span>
        <span class="hljs-keyword">if</span> (features.bitwiseOperators)
          <span class="hljs-keyword">if</span> (<span class="hljs-number">62</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-number">61</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;&gt;=&#x27;</span>);
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;&gt;&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">60</span>: <span class="hljs-comment">// &lt;</span>
        <span class="hljs-keyword">if</span> (features.bitwiseOperators)
          <span class="hljs-keyword">if</span> (<span class="hljs-number">60</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;&lt;&lt;&#x27;</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-number">61</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;&lt;=&#x27;</span>);
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;&lt;&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">126</span>: <span class="hljs-comment">// ~</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-number">61</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;~=&#x27;</span>);
        <span class="hljs-keyword">if</span> (!features.bitwiseOperators)
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;~&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">58</span>: <span class="hljs-comment">// :</span>
        <span class="hljs-keyword">if</span> (features.labels)
          <span class="hljs-keyword">if</span> (<span class="hljs-number">58</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;::&#x27;</span>);
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;:&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">91</span>: <span class="hljs-comment">// [</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Check for a multiline string, they begin with [= or [[</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-number">91</span> === next || <span class="hljs-number">61</span> === next) <span class="hljs-keyword">return</span> scanLongStringLiteral();
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;[&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">47</span>: <span class="hljs-comment">// /</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Check for integer division op (//)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (features.integerDivision)
          <span class="hljs-keyword">if</span> (<span class="hljs-number">47</span> === next) <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;//&#x27;</span>);
        <span class="hljs-keyword">return</span> scanPunctuator(<span class="hljs-string">&#x27;/&#x27;</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-number">38</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">124</span>: <span class="hljs-comment">// &amp; |</span>
        <span class="hljs-keyword">if</span> (!features.bitwiseOperators)
          <span class="hljs-keyword">break</span>;

        <span class="hljs-comment">/* fall through */</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">42</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">94</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">37</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">44</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">123</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">125</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-number">93</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">40</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">41</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">59</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">35</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">45</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-number">43</span>: <span class="hljs-comment">// * ^ % , { } ] ( ) ; # - +</span>
        <span class="hljs-keyword">return</span> scanPunctuator(input.charAt(index));
    }

    <span class="hljs-keyword">return</span> unexpected(input.charAt(index));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Whitespace has no semantic meaning in lua so simply skip ahead while
tracking the encounted newlines. Any kind of eol sequence is counted as a
single line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">consumeEOL</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> charCode = input.charCodeAt(index)
      , peekCharCode = input.charCodeAt(index + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">if</span> (isLineTerminator(charCode)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Count \n\r and \r\n as one newline.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-number">10</span> === charCode &amp;&amp; <span class="hljs-number">13</span> === peekCharCode) ++index;
      <span class="hljs-keyword">if</span> (<span class="hljs-number">13</span> === charCode &amp;&amp; <span class="hljs-number">10</span> === peekCharCode) ++index;
      ++line;
      lineStart = ++index;

      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skipWhiteSpace</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">while</span> (index &lt; length) {
      <span class="hljs-keyword">var</span> charCode = input.charCodeAt(index);
      <span class="hljs-keyword">if</span> (isWhiteSpace(charCode)) {
        ++index;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!consumeEOL()) {
        <span class="hljs-keyword">break</span>;
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Identifiers, keywords, booleans and nil all look the same syntax wise. We
simply go through them one by one and defaulting to an identifier if no
previous case matched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanIdentifierOrKeyword</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> value, type;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Slicing the input string is prefered before string concatenation in a
loop for performance reasons.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> (isIdentifierPart(input.charCodeAt(++index)));
    value = encodingMode.fixup(input.slice(tokenStart, index));</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Decide on the token type and possibly cast the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isKeyword(value)) {
      type = Keyword;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;true&#x27;</span> === value || <span class="hljs-string">&#x27;false&#x27;</span> === value) {
      type = BooleanLiteral;
      value = (<span class="hljs-string">&#x27;true&#x27;</span> === value);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;nil&#x27;</span> === value) {
      type = NilLiteral;
      value = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> {
      type = Identifier;
    }

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: type
      , <span class="hljs-attr">value</span>: value
      , <span class="hljs-attr">line</span>: line
      , <span class="hljs-attr">lineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [tokenStart, index]
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Once a punctuator reaches this function it should already have been
validated so we simply return it as a token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanPunctuator</span>(<span class="hljs-params">value</span>) </span>{
    index += value.length;
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: Punctuator
      , <span class="hljs-attr">value</span>: value
      , <span class="hljs-attr">line</span>: line
      , <span class="hljs-attr">lineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [tokenStart, index]
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>A vararg literal consists of three dots.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanVarargLiteral</span>(<span class="hljs-params"></span>) </span>{
    index += <span class="hljs-number">3</span>;
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: VarargLiteral
      , <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;...&#x27;</span>
      , <span class="hljs-attr">line</span>: line
      , <span class="hljs-attr">lineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [tokenStart, index]
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Find the string literal by matching the delimiter marks used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanStringLiteral</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> delimiter = input.charCodeAt(index++)
      , beginLine = line
      , beginLineStart = lineStart
      , stringStart = index
      , string = encodingMode.discardStrings ? <span class="hljs-literal">null</span> : <span class="hljs-string">&#x27;&#x27;</span>
      , charCode;

    <span class="hljs-keyword">for</span> (;;) {
      charCode = input.charCodeAt(index++);
      <span class="hljs-keyword">if</span> (delimiter === charCode) <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>EOF or <code>\n</code> terminates a string literal. If we haven’t found the
ending delimiter by now, raise an exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (index &gt; length || isLineTerminator(charCode)) {
        string += input.slice(stringStart, index - <span class="hljs-number">1</span>);
        raise(<span class="hljs-literal">null</span>, errors.unfinishedString, input.slice(tokenStart, index - <span class="hljs-number">1</span>));
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-number">92</span> === charCode) { <span class="hljs-comment">// backslash</span>
        <span class="hljs-keyword">if</span> (!encodingMode.discardStrings) {
          <span class="hljs-keyword">var</span> beforeEscape = input.slice(stringStart, index - <span class="hljs-number">1</span>);
          string += encodingMode.fixup(beforeEscape);
        }
        <span class="hljs-keyword">var</span> escapeValue = readEscapeSequence();
        <span class="hljs-keyword">if</span> (!encodingMode.discardStrings)
          string += escapeValue;
        stringStart = index;
      }
    }
    <span class="hljs-keyword">if</span> (!encodingMode.discardStrings) {
      string += encodingMode.encodeByte(<span class="hljs-literal">null</span>);
      string += encodingMode.fixup(input.slice(stringStart, index - <span class="hljs-number">1</span>));
    }

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: StringLiteral
      , <span class="hljs-attr">value</span>: string
      , <span class="hljs-attr">line</span>: beginLine
      , <span class="hljs-attr">lineStart</span>: beginLineStart
      , <span class="hljs-attr">lastLine</span>: line
      , <span class="hljs-attr">lastLineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [tokenStart, index]
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Expect a multiline string literal and return it as a regular string
literal, if it doesn’t validate into a valid multiline string, throw an
exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanLongStringLiteral</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> beginLine = line
      , beginLineStart = lineStart
      , string = readLongString(<span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Fail if it’s not a multiline literal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === string) raise(token, errors.expected, <span class="hljs-string">&#x27;[&#x27;</span>, tokenValue(token));

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: StringLiteral
      , <span class="hljs-attr">value</span>: encodingMode.discardStrings ? <span class="hljs-literal">null</span> : encodingMode.fixup(string)
      , <span class="hljs-attr">line</span>: beginLine
      , <span class="hljs-attr">lineStart</span>: beginLineStart
      , <span class="hljs-attr">lastLine</span>: line
      , <span class="hljs-attr">lastLineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [tokenStart, index]
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Numeric literals will be returned as floating-point numbers instead of
strings. The raw value should be retrieved from slicing the input string
later on in the process.</p>
<p>If a hexadecimal number is encountered, it will be converted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanNumericLiteral</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> character = input.charAt(index)
      , next = input.charAt(index + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">var</span> literal = (<span class="hljs-string">&#x27;0&#x27;</span> === character &amp;&amp; <span class="hljs-string">&#x27;xX&#x27;</span>.indexOf(next || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) ?
      readHexLiteral() : readDecLiteral();

    <span class="hljs-keyword">var</span> foundImaginaryUnit = readImaginaryUnitSuffix()
      , foundInt64Suffix = readInt64Suffix();

    <span class="hljs-keyword">if</span> (foundInt64Suffix &amp;&amp; (foundImaginaryUnit || literal.hasFractionPart)) {
      raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));
    }

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: NumericLiteral
      , <span class="hljs-attr">value</span>: literal.value
      , <span class="hljs-attr">line</span>: line
      , <span class="hljs-attr">lineStart</span>: lineStart
      , <span class="hljs-attr">range</span>: [tokenStart, index]
    };
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readImaginaryUnitSuffix</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!features.imaginaryNumbers) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Imaginary unit number suffix is optional.
See <a href="http://luajit.org/ext_ffi_api.html#literals">http://luajit.org/ext_ffi_api.html#literals</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;iI&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
      ++index;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readInt64Suffix</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!features.integerSuffixes) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Int64/uint64 number suffix is optional.
See <a href="http://luajit.org/ext_ffi_api.html#literals">http://luajit.org/ext_ffi_api.html#literals</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;uU&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
      ++index;
      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;lL&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
        ++index;
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;lL&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
          ++index;
          <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ULL&#x27;</span>;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>UL but no L</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));
        }
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>U but no L</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;lL&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
        ++index;
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;lL&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
          ++index;
          <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;LL&#x27;</span>;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>First L but no second L</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));
        }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Lua hexadecimals have an optional fraction part and an optional binary
exoponent part. These are not included in JavaScript so we will compute
all three parts separately and then sum them up at the end of the function
with the following algorithm.</p>
<pre><code>Digit := toDec(digit)
<span class="hljs-attr">Fraction</span> := toDec(fraction) / <span class="hljs-number">16</span> ^ fractionCount
<span class="hljs-attr">BinaryExp</span> := <span class="hljs-number">2</span> ^ binaryExp
<span class="hljs-attr">Number</span> := ( Digit + Fraction ) * BinaryExp</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readHexLiteral</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> fraction = <span class="hljs-number">0</span> <span class="hljs-comment">// defaults to 0 as it gets summed</span>
      , binaryExponent = <span class="hljs-number">1</span> <span class="hljs-comment">// defaults to 1 as it gets multiplied</span>
      , binarySign = <span class="hljs-number">1</span> <span class="hljs-comment">// positive</span>
      , digit, fractionStart, exponentStart, digitStart;

    digitStart = index += <span class="hljs-number">2</span>; <span class="hljs-comment">// Skip 0x part</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>A minimum of one hex digit is required.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!isHexDigit(input.charCodeAt(index)))
      raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));

    <span class="hljs-keyword">while</span> (isHexDigit(input.charCodeAt(index))) ++index;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Convert the hexadecimal digit to base 10.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    digit = <span class="hljs-built_in">parseInt</span>(input.slice(digitStart, index), <span class="hljs-number">16</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Fraction part is optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> foundFraction = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;.&#x27;</span> === input.charAt(index)) {
      foundFraction = <span class="hljs-literal">true</span>;
      fractionStart = ++index;

      <span class="hljs-keyword">while</span> (isHexDigit(input.charCodeAt(index))) ++index;
      fraction = input.slice(fractionStart, index);</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Empty fraction parts should default to 0, others should be converted
0.x form so we can use summation at the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      fraction = (fractionStart === index) ? <span class="hljs-number">0</span>
        : <span class="hljs-built_in">parseInt</span>(fraction, <span class="hljs-number">16</span>) / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">16</span>, index - fractionStart);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Binary exponents are optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> foundBinaryExponent = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;pP&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
      foundBinaryExponent = <span class="hljs-literal">true</span>;
      ++index;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Sign part is optional and defaults to 1 (positive).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;+-&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>)
        binarySign = (<span class="hljs-string">&#x27;+&#x27;</span> === input.charAt(index++)) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;

      exponentStart = index;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>The binary exponent sign requires a decimal digit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!isDecDigit(input.charCodeAt(index)))
        raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));

      <span class="hljs-keyword">while</span> (isDecDigit(input.charCodeAt(index))) ++index;
      binaryExponent = input.slice(exponentStart, index);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Calculate the binary exponent of the number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      binaryExponent = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, binaryExponent * binarySign);
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">value</span>: (digit + fraction) * binaryExponent,
      <span class="hljs-attr">hasFractionPart</span>: foundFraction || foundBinaryExponent
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Decimal numbers are exactly the same in Lua and in JavaScript, because of
this we check where the token ends and then parse it with native
functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readDecLiteral</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">while</span> (isDecDigit(input.charCodeAt(index))) ++index;</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Fraction part is optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> foundFraction = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;.&#x27;</span> === input.charAt(index)) {
      foundFraction = <span class="hljs-literal">true</span>;
      ++index;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Fraction part defaults to 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">while</span> (isDecDigit(input.charCodeAt(index))) ++index;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Exponent part is optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> foundExponent = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;eE&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) {
      foundExponent = <span class="hljs-literal">true</span>;
      ++index;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Sign part is optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;+-&#x27;</span>.indexOf(input.charAt(index) || <span class="hljs-literal">null</span>) &gt;= <span class="hljs-number">0</span>) ++index;</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>An exponent is required to contain at least one decimal digit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!isDecDigit(input.charCodeAt(index)))
        raise(<span class="hljs-literal">null</span>, errors.malformedNumber, input.slice(tokenStart, index));

      <span class="hljs-keyword">while</span> (isDecDigit(input.charCodeAt(index))) ++index;
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">value</span>: <span class="hljs-built_in">parseFloat</span>(input.slice(tokenStart, index)),
      <span class="hljs-attr">hasFractionPart</span>: foundFraction || foundExponent
    };
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readUnicodeEscapeSequence</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sequenceStart = index++;

    <span class="hljs-keyword">if</span> (input.charAt(index++) !== <span class="hljs-string">&#x27;{&#x27;</span>)
      raise(<span class="hljs-literal">null</span>, errors.braceExpected, <span class="hljs-string">&#x27;{&#x27;</span>, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index));
    <span class="hljs-keyword">if</span> (!isHexDigit(input.charCodeAt(index)))
      raise(<span class="hljs-literal">null</span>, errors.hexadecimalDigitExpected, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index));

    <span class="hljs-keyword">while</span> (input.charCodeAt(index) === <span class="hljs-number">0x30</span>) ++index;
    <span class="hljs-keyword">var</span> escStart = index;

    <span class="hljs-keyword">while</span> (isHexDigit(input.charCodeAt(index))) {
      ++index;
      <span class="hljs-keyword">if</span> (index - escStart &gt; <span class="hljs-number">6</span>)
        raise(<span class="hljs-literal">null</span>, errors.tooLargeCodepoint, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index));
    }

    <span class="hljs-keyword">var</span> b = input.charAt(index++);
    <span class="hljs-keyword">if</span> (b !== <span class="hljs-string">&#x27;}&#x27;</span>) {
      <span class="hljs-keyword">if</span> ((b === <span class="hljs-string">&#x27;&quot;&#x27;</span>) || (b === <span class="hljs-string">&quot;&#x27;&quot;</span>))
        raise(<span class="hljs-literal">null</span>, errors.braceExpected, <span class="hljs-string">&#x27;}&#x27;</span>, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index--));
      <span class="hljs-keyword">else</span>
        raise(<span class="hljs-literal">null</span>, errors.hexadecimalDigitExpected, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index));
    }

    <span class="hljs-keyword">var</span> codepoint = <span class="hljs-built_in">parseInt</span>(input.slice(escStart, index - <span class="hljs-number">1</span>) || <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-number">16</span>);
    <span class="hljs-keyword">var</span> frag = <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index);

    <span class="hljs-keyword">if</span> (codepoint &gt; <span class="hljs-number">0x10ffff</span>) {
      raise(<span class="hljs-literal">null</span>, errors.tooLargeCodepoint, frag);
    }

    <span class="hljs-keyword">return</span> encodingMode.encodeUTF8(codepoint, frag);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Translate escape sequences to the actual characters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readEscapeSequence</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sequenceStart = index;
    <span class="hljs-keyword">switch</span> (input.charAt(index)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Lua allow the following escape sequences.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;a&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\x07&#x27;</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;n&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\n&#x27;</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;r&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\r&#x27;</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;t&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\t&#x27;</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\x0b&#x27;</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\b&#x27;</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;f&#x27;</span>: ++index; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\f&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Backslash at the end of the line. We treat all line endings as equivalent,
and as representing the [LF] character (code 10). Lua 5.1 through 5.3
have been verified to behave the same way.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\r&#x27;</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\n&#x27;</span>:
        consumeEOL();
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\n&#x27;</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;0&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;1&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;2&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;3&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;4&#x27;</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;5&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;6&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;7&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;8&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;9&#x27;</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>\ddd, where ddd is a sequence of up to three decimal digits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">while</span> (isDecDigit(input.charCodeAt(index)) &amp;&amp; index - sequenceStart &lt; <span class="hljs-number">3</span>) ++index;

        <span class="hljs-keyword">var</span> frag = input.slice(sequenceStart, index);
        <span class="hljs-keyword">var</span> ddd = <span class="hljs-built_in">parseInt</span>(frag, <span class="hljs-number">10</span>);
        <span class="hljs-keyword">if</span> (ddd &gt; <span class="hljs-number">255</span>) {
          raise(<span class="hljs-literal">null</span>, errors.decimalEscapeTooLarge, <span class="hljs-string">&#x27;\\&#x27;</span> + ddd);
        }
        <span class="hljs-keyword">return</span> encodingMode.encodeByte(ddd, <span class="hljs-string">&#x27;\\&#x27;</span> + frag);

      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;z&#x27;</span>:
        <span class="hljs-keyword">if</span> (features.skipWhitespaceEscape) {
          ++index;
          skipWhiteSpace();
          <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;x&#x27;</span>:
        <span class="hljs-keyword">if</span> (features.hexEscapes) {</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>\xXX, where XX is a sequence of exactly two hexadecimal digits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (isHexDigit(input.charCodeAt(index + <span class="hljs-number">1</span>)) &amp;&amp;
              isHexDigit(input.charCodeAt(index + <span class="hljs-number">2</span>))) {
            index += <span class="hljs-number">3</span>;
            <span class="hljs-keyword">return</span> encodingMode.encodeByte(<span class="hljs-built_in">parseInt</span>(input.slice(sequenceStart + <span class="hljs-number">1</span>, index), <span class="hljs-number">16</span>), <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index));
          }
          raise(<span class="hljs-literal">null</span>, errors.hexadecimalDigitExpected, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index + <span class="hljs-number">2</span>));
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;u&#x27;</span>:
        <span class="hljs-keyword">if</span> (features.unicodeEscapes)
          <span class="hljs-keyword">return</span> readUnicodeEscapeSequence();
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\\&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&quot;&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;&#x27;&quot;</span>:
        <span class="hljs-keyword">return</span> input.charAt(index++);
    }

    <span class="hljs-keyword">if</span> (features.strictEscapes)
      raise(<span class="hljs-literal">null</span>, errors.invalidEscape, <span class="hljs-string">&#x27;\\&#x27;</span> + input.slice(sequenceStart, index + <span class="hljs-number">1</span>));
    <span class="hljs-keyword">return</span> input.charAt(index++);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Comments begin with – after which it will be decided if they are
multiline comments or not.</p>
<p>The multiline functionality works the exact same way as with string
literals so we reuse the functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanComment</span>(<span class="hljs-params"></span>) </span>{
    tokenStart = index;
    index += <span class="hljs-number">2</span>; <span class="hljs-comment">// --</span>

    <span class="hljs-keyword">var</span> character = input.charAt(index)
      , content = <span class="hljs-string">&#x27;&#x27;</span>
      , isLong = <span class="hljs-literal">false</span>
      , commentStart = index
      , lineStartComment = lineStart
      , lineComment = line;

    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;[&#x27;</span> === character) {
      content = readLongString(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>This wasn’t a multiline comment after all.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === content) content = character;
      <span class="hljs-keyword">else</span> isLong = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Scan until next line as long as it’s not a multiline comment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!isLong) {
      <span class="hljs-keyword">while</span> (index &lt; length) {
        <span class="hljs-keyword">if</span> (isLineTerminator(input.charCodeAt(index))) <span class="hljs-keyword">break</span>;
        ++index;
      }
      <span class="hljs-keyword">if</span> (options.comments) content = input.slice(commentStart, index);
    }

    <span class="hljs-keyword">if</span> (options.comments) {
      <span class="hljs-keyword">var</span> node = ast.comment(content, input.slice(tokenStart, index));</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p><code>Marker</code>s depend on tokens available in the parser and as comments are
intercepted in the lexer all location data is set manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (options.locations) {
        node.loc = {
            <span class="hljs-attr">start</span>: { <span class="hljs-attr">line</span>: lineComment, <span class="hljs-attr">column</span>: tokenStart - lineStartComment }
          , <span class="hljs-attr">end</span>: { <span class="hljs-attr">line</span>: line, <span class="hljs-attr">column</span>: index - lineStart }
        };
      }
      <span class="hljs-keyword">if</span> (options.ranges) {
        node.range = [tokenStart, index];
      }
      <span class="hljs-keyword">if</span> (options.onCreateNode) options.onCreateNode(node);
      comments.push(node);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Read a multiline string by calculating the depth of <code>=</code> characters and
then appending until an equal depth is found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readLongString</span>(<span class="hljs-params">isComment</span>) </span>{
    <span class="hljs-keyword">var</span> level = <span class="hljs-number">0</span>
      , content = <span class="hljs-string">&#x27;&#x27;</span>
      , terminator = <span class="hljs-literal">false</span>
      , character, stringStart, firstLine = line;

    ++index; <span class="hljs-comment">// [</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Calculate the depth of the comment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> (<span class="hljs-string">&#x27;=&#x27;</span> === input.charAt(index + level)) ++level;</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Exit, this is not a long string afterall.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;[&#x27;</span> !== input.charAt(index + level)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    index += level + <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>If the first character is a newline, ignore it and begin on next line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isLineTerminator(input.charCodeAt(index))) consumeEOL();

    stringStart = index;
    <span class="hljs-keyword">while</span> (index &lt; length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>To keep track of line numbers run the <code>consumeEOL()</code> which increments
its counter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">while</span> (isLineTerminator(input.charCodeAt(index))) consumeEOL();

      character = input.charAt(index++);</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Once the delimiter is found, iterate through the depth count and see
if it matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;]&#x27;</span> === character) {
        terminator = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; level; ++i) {
          <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;=&#x27;</span> !== input.charAt(index + i)) terminator = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;]&#x27;</span> !== input.charAt(index + level)) terminator = <span class="hljs-literal">false</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>We reached the end of the multiline string. Get out now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (terminator) {
        content += input.slice(stringStart, index - <span class="hljs-number">1</span>);
        index += level + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> content;
      }
    }

    raise(<span class="hljs-literal">null</span>, isComment ?
                errors.unfinishedLongComment :
                errors.unfinishedLongString,
          firstLine, <span class="hljs-string">&#x27;&lt;eof&gt;&#x27;</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <h2 id="lex-functions-and-helpers">Lex functions and helpers.</h2>

            </div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Read the next token.</p>
<p>This is actually done by setting the current token to the lookahead and
reading in the new lookahead token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params"></span>) </span>{
    previousToken = token;
    token = lookahead;
    lookahead = lex();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Consume a token if its value matches. Once consumed or not, return the
success of the operation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">consume</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span> (value === token.value) {
      next();
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Expect the next token value to match. If not, throw an exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expect</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span> (value === token.value) next();
    <span class="hljs-keyword">else</span> raise(token, errors.expected, value, tokenValue(token));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <h3 id="validation-functions">Validation functions</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isWhiteSpace</span>(<span class="hljs-params">charCode</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">9</span> === charCode || <span class="hljs-number">32</span> === charCode || <span class="hljs-number">0xB</span> === charCode || <span class="hljs-number">0xC</span> === charCode;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isLineTerminator</span>(<span class="hljs-params">charCode</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">10</span> === charCode || <span class="hljs-number">13</span> === charCode;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDecDigit</span>(<span class="hljs-params">charCode</span>) </span>{
    <span class="hljs-keyword">return</span> charCode &gt;= <span class="hljs-number">48</span> &amp;&amp; charCode &lt;= <span class="hljs-number">57</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isHexDigit</span>(<span class="hljs-params">charCode</span>) </span>{
    <span class="hljs-keyword">return</span> (charCode &gt;= <span class="hljs-number">48</span> &amp;&amp; charCode &lt;= <span class="hljs-number">57</span>) || (charCode &gt;= <span class="hljs-number">97</span> &amp;&amp; charCode &lt;= <span class="hljs-number">102</span>) || (charCode &gt;= <span class="hljs-number">65</span> &amp;&amp; charCode &lt;= <span class="hljs-number">70</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>From <a href="http://www.lua.org/manual/5.2/manual.html#8.1">Lua 5.2</a> onwards
identifiers cannot use ‘locale-dependent’ letters (i.e. dependent on the C locale).
On the other hand, LuaJIT allows arbitrary octets ≥ 128 in identifiers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isIdentifierStart</span>(<span class="hljs-params">charCode</span>) </span>{
    <span class="hljs-keyword">if</span> ((charCode &gt;= <span class="hljs-number">65</span> &amp;&amp; charCode &lt;= <span class="hljs-number">90</span>) || (charCode &gt;= <span class="hljs-number">97</span> &amp;&amp; charCode &lt;= <span class="hljs-number">122</span>) || <span class="hljs-number">95</span> === charCode)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (features.extendedIdentifiers &amp;&amp; charCode &gt;= <span class="hljs-number">128</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isIdentifierPart</span>(<span class="hljs-params">charCode</span>) </span>{
    <span class="hljs-keyword">if</span> ((charCode &gt;= <span class="hljs-number">65</span> &amp;&amp; charCode &lt;= <span class="hljs-number">90</span>) || (charCode &gt;= <span class="hljs-number">97</span> &amp;&amp; charCode &lt;= <span class="hljs-number">122</span>) || <span class="hljs-number">95</span> === charCode || (charCode &gt;= <span class="hljs-number">48</span> &amp;&amp; charCode &lt;= <span class="hljs-number">57</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (features.extendedIdentifiers &amp;&amp; charCode &gt;= <span class="hljs-number">128</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p><a href="http://www.lua.org/manual/5.2/manual.html#3.1">3.1 Lexical Conventions</a></p>
<p><code>true</code>, <code>false</code> and <code>nil</code> will not be considered keywords, but literals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isKeyword</span>(<span class="hljs-params">id</span>) </span>{
    <span class="hljs-keyword">switch</span> (id.length) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;do&#x27;</span> === id || <span class="hljs-string">&#x27;if&#x27;</span> === id || <span class="hljs-string">&#x27;in&#x27;</span> === id || <span class="hljs-string">&#x27;or&#x27;</span> === id;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;and&#x27;</span> === id || <span class="hljs-string">&#x27;end&#x27;</span> === id || <span class="hljs-string">&#x27;for&#x27;</span> === id || <span class="hljs-string">&#x27;not&#x27;</span> === id;
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;else&#x27;</span> === id || <span class="hljs-string">&#x27;then&#x27;</span> === id)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (features.labels &amp;&amp; !features.contextualGoto)
          <span class="hljs-keyword">return</span> (<span class="hljs-string">&#x27;goto&#x27;</span> === id);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;break&#x27;</span> === id || <span class="hljs-string">&#x27;local&#x27;</span> === id || <span class="hljs-string">&#x27;until&#x27;</span> === id || <span class="hljs-string">&#x27;while&#x27;</span> === id;
      <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;elseif&#x27;</span> === id || <span class="hljs-string">&#x27;repeat&#x27;</span> === id || <span class="hljs-string">&#x27;return&#x27;</span> === id;
      <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;function&#x27;</span> === id;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isUnary</span>(<span class="hljs-params">token</span>) </span>{
    <span class="hljs-keyword">if</span> (Punctuator === token.type) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;#-~&#x27;</span>.indexOf(token.value) &gt;= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (Keyword === token.type) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;not&#x27;</span> === token.value;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Check if the token syntactically closes a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isBlockFollow</span>(<span class="hljs-params">token</span>) </span>{
    <span class="hljs-keyword">if</span> (EOF === token.type) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (Keyword !== token.type) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">switch</span> (token.value) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;else&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;elseif&#x27;</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;end&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;until&#x27;</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <h2 id="scope">Scope</h2>

            </div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Store each block scope as a an array of identifier names. Each scope is
stored in an FILO-array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> scopes</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>The current scope index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , scopeDepth</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>A list of all global identifier nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    , globals;</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Create a new scope inheriting all declarations from the previous scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createScope</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> scope = <span class="hljs-built_in">Array</span>.apply(<span class="hljs-literal">null</span>, scopes[scopeDepth++]);
    scopes.push(scope);
    <span class="hljs-keyword">if</span> (options.onCreateScope) options.onCreateScope();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Exit and remove the current scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyScope</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> scope = scopes.pop();
    --scopeDepth;
    <span class="hljs-keyword">if</span> (options.onDestroyScope) options.onDestroyScope();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Add identifier name to the current scope if it doesnt already exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeIdentifierName</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">if</span> (options.onLocalDeclaration) options.onLocalDeclaration(name);
    <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> !== indexOf(scopes[scopeDepth], name)) <span class="hljs-keyword">return</span>;
    scopes[scopeDepth].push(name);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Add identifier to the current scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeIdentifier</span>(<span class="hljs-params">node</span>) </span>{
    scopeIdentifierName(node.name);
    attachScope(node, <span class="hljs-literal">true</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Attach scope information to node. If the node is global, store it in the
globals array so we can return the information to the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attachScope</span>(<span class="hljs-params">node, isLocal</span>) </span>{
    <span class="hljs-keyword">if</span> (!isLocal &amp;&amp; -<span class="hljs-number">1</span> === indexOfObject(globals, <span class="hljs-string">&#x27;name&#x27;</span>, node.name))
      globals.push(node);

    node.isLocal = isLocal;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Is the identifier name available in this scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeHasName</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">return</span> (-<span class="hljs-number">1</span> !== indexOf(scopes[scopeDepth], name));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <h2 id="location-tracking">Location tracking</h2>

            </div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Locations are stored in FILO-array as a <code>Marker</code> object consisting of both
<code>loc</code> and <code>range</code> data. Once a <code>Marker</code> is popped off the list an end
location is added and the data is attached to a syntax node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> locations = []
    , trackLocations;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createLocationMarker</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Marker(token);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Marker</span>(<span class="hljs-params">token</span>) </span>{
    <span class="hljs-keyword">if</span> (options.locations) {
      <span class="hljs-built_in">this</span>.loc = {
          <span class="hljs-attr">start</span>: {
            <span class="hljs-attr">line</span>: token.line
          , <span class="hljs-attr">column</span>: token.range[<span class="hljs-number">0</span>] - token.lineStart
        }
        , <span class="hljs-attr">end</span>: {
            <span class="hljs-attr">line</span>: <span class="hljs-number">0</span>
          , <span class="hljs-attr">column</span>: <span class="hljs-number">0</span>
        }
      };
    }
    <span class="hljs-keyword">if</span> (options.ranges) <span class="hljs-built_in">this</span>.range = [token.range[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Complete the location data stored in the <code>Marker</code> by adding the location
of the <em>previous token</em> as an end location.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Marker.prototype.complete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (options.locations) {
      <span class="hljs-built_in">this</span>.loc.end.line = previousToken.lastLine || previousToken.line;
      <span class="hljs-built_in">this</span>.loc.end.column = previousToken.range[<span class="hljs-number">1</span>] - (previousToken.lastLineStart || previousToken.lineStart);
    }
    <span class="hljs-keyword">if</span> (options.ranges) {
      <span class="hljs-built_in">this</span>.range[<span class="hljs-number">1</span>] = previousToken.range[<span class="hljs-number">1</span>];
    }
  };

  Marker.prototype.bless = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.loc) {
      <span class="hljs-keyword">var</span> loc = <span class="hljs-built_in">this</span>.loc;
      node.loc = {
        <span class="hljs-attr">start</span>: {
          <span class="hljs-attr">line</span>: loc.start.line,
          <span class="hljs-attr">column</span>: loc.start.column
        },
        <span class="hljs-attr">end</span>: {
          <span class="hljs-attr">line</span>: loc.end.line,
          <span class="hljs-attr">column</span>: loc.end.column
        }
      };
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.range) {
      node.range = [
        <span class="hljs-built_in">this</span>.range[<span class="hljs-number">0</span>],
        <span class="hljs-built_in">this</span>.range[<span class="hljs-number">1</span>]
      ];
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Create a new <code>Marker</code> and add it to the FILO-array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">markLocation</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (trackLocations) locations.push(createLocationMarker());
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Push an arbitrary <code>Marker</code> object onto the FILO-array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushLocation</span>(<span class="hljs-params">marker</span>) </span>{
    <span class="hljs-keyword">if</span> (trackLocations) locations.push(marker);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <h2 id="control-flow-tracking">Control flow tracking</h2>

            </div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>A context object that validates loop breaks and <code>goto</code>-based control flow.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FullFlowContext</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">this</span>.scopes = [];
    <span class="hljs-built_in">this</span>.pendingGotos = [];
  }

  FullFlowContext.prototype.isInLoop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> i = <span class="hljs-built_in">this</span>.scopes.length;
    <span class="hljs-keyword">while</span> (i --&gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.scopes[i].isLoop)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  };

  FullFlowContext.prototype.pushScope = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">isLoop</span>) </span>{
    <span class="hljs-keyword">var</span> scope = {
      <span class="hljs-attr">labels</span>: {},
      <span class="hljs-attr">locals</span>: [],
      <span class="hljs-attr">deferredGotos</span>: [],
      <span class="hljs-attr">isLoop</span>: !!isLoop
    };
    <span class="hljs-built_in">this</span>.scopes.push(scope);
  };

  FullFlowContext.prototype.popScope = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.pendingGotos.length; ++i) {
      <span class="hljs-keyword">var</span> theGoto = <span class="hljs-built_in">this</span>.pendingGotos[i];
      <span class="hljs-keyword">if</span> (theGoto.maxDepth &gt;= <span class="hljs-built_in">this</span>.scopes.length)
        <span class="hljs-keyword">if</span> (--theGoto.maxDepth &lt;= <span class="hljs-number">0</span>)
          raise(theGoto.token, errors.labelNotVisible, theGoto.target);
    }

    <span class="hljs-built_in">this</span>.scopes.pop();
  };

  FullFlowContext.prototype.addGoto = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">target, token</span>) </span>{
    <span class="hljs-keyword">var</span> localCounts = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.scopes.length; ++i) {
      <span class="hljs-keyword">var</span> scope = <span class="hljs-built_in">this</span>.scopes[i];
      localCounts.push(scope.locals.length);
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(scope.labels, target))
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-built_in">this</span>.pendingGotos.push({
      <span class="hljs-attr">maxDepth</span>: <span class="hljs-built_in">this</span>.scopes.length,
      <span class="hljs-attr">target</span>: target,
      <span class="hljs-attr">token</span>: token,
      <span class="hljs-attr">localCounts</span>: localCounts
    });
  };

  FullFlowContext.prototype.addLabel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, token</span>) </span>{
    <span class="hljs-keyword">var</span> scope = <span class="hljs-built_in">this</span>.currentScope();

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(scope.labels, name)) {
      raise(token, errors.labelAlreadyDefined, name, scope.labels[name].line);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> newGotos = [];

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.pendingGotos.length; ++i) {
        <span class="hljs-keyword">var</span> theGoto = <span class="hljs-built_in">this</span>.pendingGotos[i];

        <span class="hljs-keyword">if</span> (theGoto.maxDepth &gt;= <span class="hljs-built_in">this</span>.scopes.length &amp;&amp; theGoto.target === name) {
          <span class="hljs-keyword">if</span> (theGoto.localCounts[<span class="hljs-built_in">this</span>.scopes.length - <span class="hljs-number">1</span>] &lt; scope.locals.length) {
            scope.deferredGotos.push(theGoto);
          }
          <span class="hljs-keyword">continue</span>;
        }

        newGotos.push(theGoto);
      }

      <span class="hljs-built_in">this</span>.pendingGotos = newGotos;
    }

    scope.labels[name] = {
      <span class="hljs-attr">localCount</span>: scope.locals.length,
      <span class="hljs-attr">line</span>: token.line
    };
  };

  FullFlowContext.prototype.addLocal = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, token</span>) </span>{
    <span class="hljs-built_in">this</span>.currentScope().locals.push({
      <span class="hljs-attr">name</span>: name,
      <span class="hljs-attr">token</span>: token
    });
  };

  FullFlowContext.prototype.currentScope = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.scopes[<span class="hljs-built_in">this</span>.scopes.length - <span class="hljs-number">1</span>];
  };

  FullFlowContext.prototype.raiseDeferredErrors = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> scope = <span class="hljs-built_in">this</span>.currentScope();
    <span class="hljs-keyword">var</span> bads = scope.deferredGotos;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; bads.length; ++i) {
      <span class="hljs-keyword">var</span> theGoto = bads[i];
      raise(theGoto.token, errors.gotoJumpInLocalScope, theGoto.target, scope.locals[theGoto.localCounts[<span class="hljs-built_in">this</span>.scopes.length - <span class="hljs-number">1</span>]].name);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Would be dead code currently, but may be useful later
if (bads.length)
  scope.deferredGotos = [];</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  };</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Simplified context that only checks the validity of loop breaks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LoopFlowContext</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">this</span>.level = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">this</span>.loopLevels = [];
  }

  LoopFlowContext.prototype.isInLoop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> !!<span class="hljs-built_in">this</span>.loopLevels.length;
  };

  LoopFlowContext.prototype.pushScope = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">isLoop</span>) </span>{
    ++<span class="hljs-built_in">this</span>.level;
    <span class="hljs-keyword">if</span> (isLoop)
      <span class="hljs-built_in">this</span>.loopLevels.push(<span class="hljs-built_in">this</span>.level);
  };

  LoopFlowContext.prototype.popScope = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> levels = <span class="hljs-built_in">this</span>.loopLevels;
    <span class="hljs-keyword">var</span> levlen = levels.length;
    <span class="hljs-keyword">if</span> (levlen) {
      <span class="hljs-keyword">if</span> (levels[levlen - <span class="hljs-number">1</span>] === <span class="hljs-built_in">this</span>.level)
        levels.pop();
    }
    --<span class="hljs-built_in">this</span>.level;
  };

  LoopFlowContext.prototype.addGoto =
  LoopFlowContext.prototype.addLabel =
  <span class="hljs-comment">/* istanbul ignore next */</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;This should never happen&#x27;</span>); };

  LoopFlowContext.prototype.addLocal =
  LoopFlowContext.prototype.raiseDeferredErrors =
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeFlowContext</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> features.labels ? <span class="hljs-keyword">new</span> FullFlowContext() : <span class="hljs-keyword">new</span> LoopFlowContext();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <h2 id="parse-functions">Parse functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Chunk is the main program object. Syntactically it’s the same as a block.</p>
<pre><code>chunk ::= block</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseChunk</span>(<span class="hljs-params"></span>) </span>{
    next();
    markLocation();
    <span class="hljs-keyword">if</span> (options.scope) createScope();
    <span class="hljs-keyword">var</span> flowContext = makeFlowContext();
    flowContext.allowVararg = <span class="hljs-literal">true</span>;
    flowContext.pushScope();
    <span class="hljs-keyword">var</span> body = parseBlock(flowContext);
    flowContext.popScope();
    <span class="hljs-keyword">if</span> (options.scope) destroyScope();
    <span class="hljs-keyword">if</span> (EOF !== token.type) unexpected(token);</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>If the body is empty no previousToken exists when finishNode runs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (trackLocations &amp;&amp; !body.length) previousToken = token;
    <span class="hljs-keyword">return</span> finishNode(ast.chunk(body));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>A block contains a list of statements with an optional return statement
as its last statement.</p>
<pre><code>block ::= {stat} [retstat]</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseBlock</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> block = []
      , statement;

    <span class="hljs-keyword">while</span> (!isBlockFollow(token)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Return has to be the last statement in a block.
Likewise ‘break’ in Lua older than 5.2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;return&#x27;</span> === token.value || (!features.relaxedBreak &amp;&amp; <span class="hljs-string">&#x27;break&#x27;</span> === token.value)) {
        block.push(parseStatement(flowContext));
        <span class="hljs-keyword">break</span>;
      }
      statement = parseStatement(flowContext);
      consume(<span class="hljs-string">&#x27;;&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Statements are only added if they are returned, this allows us to
ignore some statements, such as EmptyStatement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (statement) block.push(statement);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Doesn’t really need an ast node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> block;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>There are two types of statements, simple and compound.</p>
<pre><code>statement ::= <span class="hljs-keyword">break</span> | goto | <span class="hljs-keyword">do</span> | <span class="hljs-keyword">while</span> | repeat | <span class="hljs-keyword">return</span>
     | <span class="hljs-keyword">if</span> | <span class="hljs-keyword">for</span> | <span class="hljs-function"><span class="hljs-keyword">function</span> | <span class="hljs-title">local</span> | <span class="hljs-title">label</span> | <span class="hljs-title">assignment</span>
     | <span class="hljs-title">functioncall</span> | &#x27;</span>;<span class="hljs-string">&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    markLocation();

    <span class="hljs-keyword">if</span> (Punctuator === token.type) {
      <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;::&#x27;</span>)) <span class="hljs-keyword">return</span> parseLabelStatement(flowContext);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>When a <code>;</code> is encounted, simply eat it without storing it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (features.emptyStatement) {
      <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;;&#x27;</span>)) {
        <span class="hljs-keyword">if</span> (trackLocations) locations.pop();
        <span class="hljs-keyword">return</span>;
      }
    }

    flowContext.raiseDeferredErrors();

    <span class="hljs-keyword">if</span> (Keyword === token.type) {
      <span class="hljs-keyword">switch</span> (token.value) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;local&#x27;</span>:    next(); <span class="hljs-keyword">return</span> parseLocalStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;if&#x27;</span>:       next(); <span class="hljs-keyword">return</span> parseIfStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;return&#x27;</span>:   next(); <span class="hljs-keyword">return</span> parseReturnStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;function&#x27;</span>: next();
          <span class="hljs-keyword">var</span> name = parseFunctionName();
          <span class="hljs-keyword">return</span> parseFunctionDeclaration(name);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;while&#x27;</span>:    next(); <span class="hljs-keyword">return</span> parseWhileStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;for&#x27;</span>:      next(); <span class="hljs-keyword">return</span> parseForStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;repeat&#x27;</span>:   next(); <span class="hljs-keyword">return</span> parseRepeatStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;break&#x27;</span>:    next();
          <span class="hljs-keyword">if</span> (!flowContext.isInLoop())
            raise(token, errors.noLoopToBreak, token.value);
          <span class="hljs-keyword">return</span> parseBreakStatement();
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;do&#x27;</span>:       next(); <span class="hljs-keyword">return</span> parseDoStatement(flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;goto&#x27;</span>:     next(); <span class="hljs-keyword">return</span> parseGotoStatement(flowContext);
      }
    }

    <span class="hljs-keyword">if</span> (features.contextualGoto &amp;&amp;
        token.type === Identifier &amp;&amp; token.value === <span class="hljs-string">&#x27;goto&#x27;</span> &amp;&amp;
        lookahead.type === Identifier &amp;&amp; lookahead.value !== <span class="hljs-string">&#x27;goto&#x27;</span>) {
      next(); <span class="hljs-keyword">return</span> parseGotoStatement(flowContext);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Assignments memorizes the location and pushes it manually for wrapper nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (trackLocations) locations.pop();

    <span class="hljs-keyword">return</span> parseAssignmentOrCallStatement(flowContext);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <h2 id="statements">Statements</h2>

            </div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <pre><code>label ::= <span class="hljs-string">&#x27;::&#x27;</span> Name <span class="hljs-string">&#x27;::&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseLabelStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> nameToken = token
      , label = parseIdentifier();

    <span class="hljs-keyword">if</span> (options.scope) {
      scopeIdentifierName(<span class="hljs-string">&#x27;::&#x27;</span> + nameToken.value + <span class="hljs-string">&#x27;::&#x27;</span>);
      attachScope(label, <span class="hljs-literal">true</span>);
    }

    expect(<span class="hljs-string">&#x27;::&#x27;</span>);

    flowContext.addLabel(nameToken.value, nameToken);
    <span class="hljs-keyword">return</span> finishNode(ast.labelStatement(label));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <pre><code><span class="hljs-keyword">break</span> ::= <span class="hljs-string">&#x27;break&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseBreakStatement</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> finishNode(ast.breakStatement());
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <pre><code>goto ::= <span class="hljs-string">&#x27;goto&#x27;</span> Name</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseGotoStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> name = token.value
      , gotoToken = previousToken
      , label = parseIdentifier();

    flowContext.addGoto(name, gotoToken);
    <span class="hljs-keyword">return</span> finishNode(ast.gotoStatement(label));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <pre><code><span class="hljs-keyword">do</span> ::= <span class="hljs-string">&#x27;do&#x27;</span> block <span class="hljs-string">&#x27;end&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDoStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">if</span> (options.scope) createScope();
    flowContext.pushScope();
    <span class="hljs-keyword">var</span> body = parseBlock(flowContext);
    flowContext.popScope();
    <span class="hljs-keyword">if</span> (options.scope) destroyScope();
    expect(<span class="hljs-string">&#x27;end&#x27;</span>);
    <span class="hljs-keyword">return</span> finishNode(ast.doStatement(body));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <pre><code><span class="hljs-keyword">while</span> ::= <span class="hljs-string">&#x27;while&#x27;</span> exp <span class="hljs-string">&#x27;do&#x27;</span> block <span class="hljs-string">&#x27;end&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseWhileStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> condition = parseExpectedExpression(flowContext);
    expect(<span class="hljs-string">&#x27;do&#x27;</span>);
    <span class="hljs-keyword">if</span> (options.scope) createScope();
    flowContext.pushScope(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> body = parseBlock(flowContext);
    flowContext.popScope();
    <span class="hljs-keyword">if</span> (options.scope) destroyScope();
    expect(<span class="hljs-string">&#x27;end&#x27;</span>);
    <span class="hljs-keyword">return</span> finishNode(ast.whileStatement(condition, body));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <pre><code>repeat ::= <span class="hljs-string">&#x27;repeat&#x27;</span> block <span class="hljs-string">&#x27;until&#x27;</span> exp</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseRepeatStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">if</span> (options.scope) createScope();
    flowContext.pushScope(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> body = parseBlock(flowContext);
    expect(<span class="hljs-string">&#x27;until&#x27;</span>);
    flowContext.raiseDeferredErrors();
    <span class="hljs-keyword">var</span> condition = parseExpectedExpression(flowContext);
    flowContext.popScope();
    <span class="hljs-keyword">if</span> (options.scope) destroyScope();
    <span class="hljs-keyword">return</span> finishNode(ast.repeatStatement(condition, body));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <pre><code>retstat ::= <span class="hljs-string">&#x27;return&#x27;</span> [exp {<span class="hljs-string">&#x27;,&#x27;</span> exp}] [<span class="hljs-string">&#x27;;&#x27;</span>]</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseReturnStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> expressions = [];

    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;end&#x27;</span> !== token.value) {
      <span class="hljs-keyword">var</span> expression = parseExpression(flowContext);
      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != expression) expressions.push(expression);
      <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>)) {
        expression = parseExpectedExpression(flowContext);
        expressions.push(expression);
      }
      consume(<span class="hljs-string">&#x27;;&#x27;</span>); <span class="hljs-comment">// grammar tells us ; is optional here.</span>
    }
    <span class="hljs-keyword">return</span> finishNode(ast.returnStatement(expressions));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <pre><code><span class="hljs-keyword">if</span> ::= <span class="hljs-string">&#x27;if&#x27;</span> exp <span class="hljs-string">&#x27;then&#x27;</span> block {elif} [<span class="hljs-string">&#x27;else&#x27;</span> block] <span class="hljs-string">&#x27;end&#x27;</span>
<span class="hljs-attr">elif</span> ::= <span class="hljs-string">&#x27;elseif&#x27;</span> exp <span class="hljs-string">&#x27;then&#x27;</span> block</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseIfStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> clauses = []
      , condition
      , body
      , marker;</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>IfClauses begin at the same location as the parent IfStatement.
It ends at the start of <code>end</code>, <code>else</code>, or <code>elseif</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (trackLocations) {
      marker = locations[locations.length - <span class="hljs-number">1</span>];
      locations.push(marker);
    }
    condition = parseExpectedExpression(flowContext);
    expect(<span class="hljs-string">&#x27;then&#x27;</span>);
    <span class="hljs-keyword">if</span> (options.scope) createScope();
    flowContext.pushScope();
    body = parseBlock(flowContext);
    flowContext.popScope();
    <span class="hljs-keyword">if</span> (options.scope) destroyScope();
    clauses.push(finishNode(ast.ifClause(condition, body)));

    <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();
    <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;elseif&#x27;</span>)) {
      pushLocation(marker);
      condition = parseExpectedExpression(flowContext);
      expect(<span class="hljs-string">&#x27;then&#x27;</span>);
      <span class="hljs-keyword">if</span> (options.scope) createScope();
      flowContext.pushScope();
      body = parseBlock(flowContext);
      flowContext.popScope();
      <span class="hljs-keyword">if</span> (options.scope) destroyScope();
      clauses.push(finishNode(ast.elseifClause(condition, body)));
      <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();
    }

    <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;else&#x27;</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Include the <code>else</code> in the location of ElseClause.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (trackLocations) {
        marker = <span class="hljs-keyword">new</span> Marker(previousToken);
        locations.push(marker);
      }
      <span class="hljs-keyword">if</span> (options.scope) createScope();
      flowContext.pushScope();
      body = parseBlock(flowContext);
      flowContext.popScope();
      <span class="hljs-keyword">if</span> (options.scope) destroyScope();
      clauses.push(finishNode(ast.elseClause(body)));
    }

    expect(<span class="hljs-string">&#x27;end&#x27;</span>);
    <span class="hljs-keyword">return</span> finishNode(ast.ifStatement(clauses));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>There are two types of for statements, generic and numeric.</p>
<pre><code><span class="hljs-keyword">for</span> ::= Name <span class="hljs-string">&#x27;=&#x27;</span> exp <span class="hljs-string">&#x27;,&#x27;</span> exp [<span class="hljs-string">&#x27;,&#x27;</span> exp] <span class="hljs-string">&#x27;do&#x27;</span> block <span class="hljs-string">&#x27;end&#x27;</span>
<span class="hljs-attr">for</span> ::= namelist <span class="hljs-string">&#x27;in&#x27;</span> explist <span class="hljs-string">&#x27;do&#x27;</span> block <span class="hljs-string">&#x27;end&#x27;</span>
<span class="hljs-attr">namelist</span> ::= Name {<span class="hljs-string">&#x27;,&#x27;</span> Name}
<span class="hljs-attr">explist</span> ::= exp {<span class="hljs-string">&#x27;,&#x27;</span> exp}</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseForStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> variable = parseIdentifier()
      , body;</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>The start-identifier is local.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> (options.scope) {
      createScope();
      scopeIdentifier(variable);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>If the first expression is followed by a <code>=</code> punctuator, this is a
Numeric For Statement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;=&#x27;</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Start expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> start = parseExpectedExpression(flowContext);
      expect(<span class="hljs-string">&#x27;,&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>End expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> end = parseExpectedExpression(flowContext);</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Optional step expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> step = consume(<span class="hljs-string">&#x27;,&#x27;</span>) ? parseExpectedExpression(flowContext) : <span class="hljs-literal">null</span>;

      expect(<span class="hljs-string">&#x27;do&#x27;</span>);
      flowContext.pushScope(<span class="hljs-literal">true</span>);
      body = parseBlock(flowContext);
      flowContext.popScope();
      expect(<span class="hljs-string">&#x27;end&#x27;</span>);
      <span class="hljs-keyword">if</span> (options.scope) destroyScope();

      <span class="hljs-keyword">return</span> finishNode(ast.forNumericStatement(variable, start, end, step, body));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>If not, it’s a Generic For Statement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>The namelist can contain one or more identifiers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> variables = [variable];
      <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>)) {
        variable = parseIdentifier();</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Each variable in the namelist is locally scoped.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (options.scope) scopeIdentifier(variable);
        variables.push(variable);
      }
      expect(<span class="hljs-string">&#x27;in&#x27;</span>);
      <span class="hljs-keyword">var</span> iterators = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>One or more expressions in the explist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">var</span> expression = parseExpectedExpression(flowContext);
        iterators.push(expression);
      } <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>));

      expect(<span class="hljs-string">&#x27;do&#x27;</span>);
      flowContext.pushScope(<span class="hljs-literal">true</span>);
      body = parseBlock(flowContext);
      flowContext.popScope();
      expect(<span class="hljs-string">&#x27;end&#x27;</span>);
      <span class="hljs-keyword">if</span> (options.scope) destroyScope();

      <span class="hljs-keyword">return</span> finishNode(ast.forGenericStatement(variables, iterators, body));
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Local statements can either be variable assignments or function
definitions. If a function definition is found, it will be delegated to
<code>parseFunctionDeclaration()</code> with the isLocal flag.</p>
<p>This AST structure might change into a local assignment with a function
child.</p>
<pre><code>local ::= <span class="hljs-string">&#x27;local&#x27;</span> <span class="hljs-string">&#x27;function&#x27;</span> Name funcdecl
   | <span class="hljs-string">&#x27;local&#x27;</span> Name {<span class="hljs-string">&#x27;,&#x27;</span> Name} [<span class="hljs-string">&#x27;=&#x27;</span> exp {<span class="hljs-string">&#x27;,&#x27;</span> exp}]</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseLocalStatement</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> name
      , declToken = previousToken;

    <span class="hljs-keyword">if</span> (Identifier === token.type) {
      <span class="hljs-keyword">var</span> variables = []
        , init = [];

      <span class="hljs-keyword">do</span> {
        name = parseIdentifier();

        variables.push(name);
        flowContext.addLocal(name.name, declToken);
      } <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>));

      <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;=&#x27;</span>)) {
        <span class="hljs-keyword">do</span> {
          <span class="hljs-keyword">var</span> expression = parseExpectedExpression(flowContext);
          init.push(expression);
        } <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>));
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Declarations doesn’t exist before the statement has been evaluated.
Therefore assignments can’t use their declarator. And the identifiers
shouldn’t be added to the scope until the statement is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (options.scope) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = variables.length; i &lt; l; ++i) {
          scopeIdentifier(variables[i]);
        }
      }

      <span class="hljs-keyword">return</span> finishNode(ast.localStatement(variables, init));
    }
    <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;function&#x27;</span>)) {
      name = parseIdentifier();
      flowContext.addLocal(name.name, declToken);

      <span class="hljs-keyword">if</span> (options.scope) {
        scopeIdentifier(name);
        createScope();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>MemberExpressions are not allowed in local function statements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> parseFunctionDeclaration(name, <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> {
      raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;name&gt;&#x27;</span>, token);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <pre><code>assignment ::= varlist <span class="hljs-string">&#x27;=&#x27;</span> explist
<span class="hljs-attr">var</span> ::= Name | prefixexp <span class="hljs-string">&#x27;[&#x27;</span> exp <span class="hljs-string">&#x27;]&#x27;</span> | prefixexp <span class="hljs-string">&#x27;.&#x27;</span> Name
<span class="hljs-attr">varlist</span> ::= <span class="hljs-keyword">var</span> {<span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-keyword">var</span>}
<span class="hljs-attr">explist</span> ::= exp {<span class="hljs-string">&#x27;,&#x27;</span> exp}

<span class="hljs-attr">call</span> ::= callexp
<span class="hljs-attr">callexp</span> ::= prefixexp args | prefixexp <span class="hljs-string">&#x27;:&#x27;</span> Name args</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseAssignmentOrCallStatement</span>(<span class="hljs-params">flowContext</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Keep a reference to the previous token for better error messages in case
of invalid statement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> previous = token
      , marker, startMarker;
    <span class="hljs-keyword">var</span> lvalue, base, name;

    <span class="hljs-keyword">var</span> targets = [];

    <span class="hljs-keyword">if</span> (trackLocations) startMarker = createLocationMarker();

    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();

      <span class="hljs-keyword">if</span> (Identifier === token.type) {
        name = token.value;
        base = parseIdentifier();</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Set the parent scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (options.scope) attachScope(base, scopeHasName(name));
        lvalue = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;(&#x27;</span> === token.value) {
        next();
        base = parseExpectedExpression(flowContext);
        expect(<span class="hljs-string">&#x27;)&#x27;</span>);
        lvalue = <span class="hljs-literal">false</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> unexpected(token);
      }

      <span class="hljs-attr">both</span>: <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">var</span> newBase;

        <span class="hljs-keyword">switch</span> (StringLiteral === token.type ? <span class="hljs-string">&#x27;&quot;&#x27;</span> : token.value) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;.&#x27;</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[&#x27;</span>:
          lvalue = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;:&#x27;</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;(&#x27;</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;{&#x27;</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&quot;&#x27;</span>:
          lvalue = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">break</span> both;
        }

        base = parsePrefixExpressionPart(base, marker, flowContext);
      }

      targets.push(base);

      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;,&#x27;</span> !== token.value)
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">if</span> (!lvalue) {
        <span class="hljs-keyword">return</span> unexpected(token);
      }

      next();
    } <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">if</span> (targets.length === <span class="hljs-number">1</span> &amp;&amp; lvalue === <span class="hljs-literal">null</span>) {
      pushLocation(marker);
      <span class="hljs-keyword">return</span> finishNode(ast.callStatement(targets[<span class="hljs-number">0</span>]));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!lvalue) {
      <span class="hljs-keyword">return</span> unexpected(token);
    }

    expect(<span class="hljs-string">&#x27;=&#x27;</span>);

    <span class="hljs-keyword">var</span> values = [];

    <span class="hljs-keyword">do</span> {
      values.push(parseExpectedExpression(flowContext));
    } <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>));

    pushLocation(startMarker);
    <span class="hljs-keyword">return</span> finishNode(ast.assignmentStatement(targets, values));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <h3 id="non-statements">Non-statements</h3>

            </div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <pre><code>Identifier ::= Name</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseIdentifier</span>(<span class="hljs-params"></span>) </span>{
    markLocation();
    <span class="hljs-keyword">var</span> identifier = token.value;
    <span class="hljs-keyword">if</span> (Identifier !== token.type) raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;name&gt;&#x27;</span>, token);
    next();
    <span class="hljs-keyword">return</span> finishNode(ast.identifier(identifier));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Parse the functions parameters and body block. The name should already
have been parsed and passed to this declaration function. By separating
this we allow for anonymous functions in expressions.</p>
<p>For local functions there’s a boolean parameter which needs to be set
when parsing the declaration.</p>
<pre><code>funcdecl ::= <span class="hljs-string">&#x27;(&#x27;</span> [parlist] <span class="hljs-string">&#x27;)&#x27;</span> block <span class="hljs-string">&#x27;end&#x27;</span>
<span class="hljs-attr">parlist</span> ::= Name {<span class="hljs-string">&#x27;,&#x27;</span> Name} | [<span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-string">&#x27;...&#x27;</span>] | <span class="hljs-string">&#x27;...&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseFunctionDeclaration</span>(<span class="hljs-params">name, isLocal</span>) </span>{
    <span class="hljs-keyword">var</span> flowContext = makeFlowContext();
    flowContext.pushScope();

    <span class="hljs-keyword">var</span> parameters = [];
    expect(<span class="hljs-string">&#x27;(&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>The declaration has arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!consume(<span class="hljs-string">&#x27;)&#x27;</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Arguments are a comma separated list of identifiers, optionally ending
with a vararg.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">if</span> (Identifier === token.type) {
          <span class="hljs-keyword">var</span> parameter = parseIdentifier();</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Function parameters are local.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (options.scope) scopeIdentifier(parameter);

          parameters.push(parameter);

          <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>)) <span class="hljs-keyword">continue</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>No arguments are allowed after a vararg.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VarargLiteral === token.type) {
          flowContext.allowVararg = <span class="hljs-literal">true</span>;
          parameters.push(parsePrimaryExpression(flowContext));
        } <span class="hljs-keyword">else</span> {
          raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;name&gt; or \&#x27;...\&#x27;&#x27;</span>, token);
        }
        expect(<span class="hljs-string">&#x27;)&#x27;</span>);
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">var</span> body = parseBlock(flowContext);
    flowContext.popScope();
    expect(<span class="hljs-string">&#x27;end&#x27;</span>);
    <span class="hljs-keyword">if</span> (options.scope) destroyScope();

    isLocal = isLocal || <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> finishNode(ast.functionStatement(name, parameters, isLocal, body));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>Parse the function name as identifiers and member expressions.</p>
<pre><code>Name {<span class="hljs-string">&#x27;.&#x27;</span> Name} [<span class="hljs-string">&#x27;:&#x27;</span> Name]</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseFunctionName</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> base, name, marker;

    <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();
    base = parseIdentifier();

    <span class="hljs-keyword">if</span> (options.scope) {
      attachScope(base, scopeHasName(base.name));
      createScope();
    }

    <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;.&#x27;</span>)) {
      pushLocation(marker);
      name = parseIdentifier();
      base = finishNode(ast.memberExpression(base, <span class="hljs-string">&#x27;.&#x27;</span>, name));
    }

    <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;:&#x27;</span>)) {
      pushLocation(marker);
      name = parseIdentifier();
      base = finishNode(ast.memberExpression(base, <span class="hljs-string">&#x27;:&#x27;</span>, name));
      <span class="hljs-keyword">if</span> (options.scope) scopeIdentifierName(<span class="hljs-string">&#x27;self&#x27;</span>);
    }

    <span class="hljs-keyword">return</span> base;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <pre><code>tableconstructor ::= <span class="hljs-string">&#x27;{&#x27;</span> [fieldlist] <span class="hljs-string">&#x27;}&#x27;</span>
<span class="hljs-attr">fieldlist</span> ::= field {fieldsep field} fieldsep
<span class="hljs-attr">field</span> ::= <span class="hljs-string">&#x27;[&#x27;</span> exp <span class="hljs-string">&#x27;]&#x27;</span> <span class="hljs-string">&#x27;=&#x27;</span> exp | Name = <span class="hljs-string">&#x27;exp&#x27;</span> | exp

<span class="hljs-attr">fieldsep</span> ::= <span class="hljs-string">&#x27;,&#x27;</span> | <span class="hljs-string">&#x27;;&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseTableConstructor</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> fields = []
      , key, value;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      markLocation();
      <span class="hljs-keyword">if</span> (Punctuator === token.type &amp;&amp; consume(<span class="hljs-string">&#x27;[&#x27;</span>)) {
        key = parseExpectedExpression(flowContext);
        expect(<span class="hljs-string">&#x27;]&#x27;</span>);
        expect(<span class="hljs-string">&#x27;=&#x27;</span>);
        value = parseExpectedExpression(flowContext);
        fields.push(finishNode(ast.tableKey(key, value)));
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Identifier === token.type) {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;=&#x27;</span> === lookahead.value) {
          key = parseIdentifier();
          next();
          value = parseExpectedExpression(flowContext);
          fields.push(finishNode(ast.tableKeyString(key, value)));
        } <span class="hljs-keyword">else</span> {
          value = parseExpectedExpression(flowContext);
          fields.push(finishNode(ast.tableValue(value)));
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == (value = parseExpression(flowContext))) {
          locations.pop();
          <span class="hljs-keyword">break</span>;
        }
        fields.push(finishNode(ast.tableValue(value)));
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;,;&#x27;</span>.indexOf(token.value) &gt;= <span class="hljs-number">0</span>) {
        next();
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">break</span>;
    }
    expect(<span class="hljs-string">&#x27;}&#x27;</span>);
    <span class="hljs-keyword">return</span> finishNode(ast.tableConstructorExpression(fields));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <h2 id="expression-parser">Expression parser</h2>

            </div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Expressions are evaluated and always return a value. If nothing is
matched null will be returned.</p>
<pre><code>exp ::= (unop exp | primary | prefixexp ) { binop exp }

<span class="hljs-attr">primary</span> ::= nil | <span class="hljs-literal">false</span> | <span class="hljs-literal">true</span> | <span class="hljs-built_in">Number</span> | <span class="hljs-built_in">String</span> | <span class="hljs-string">&#x27;...&#x27;</span>
     | functiondef | tableconstructor

<span class="hljs-attr">prefixexp</span> ::= (Name | <span class="hljs-string">&#x27;(&#x27;</span> exp <span class="hljs-string">&#x27;)&#x27;</span> ) { <span class="hljs-string">&#x27;[&#x27;</span> exp <span class="hljs-string">&#x27;]&#x27;</span>
     | <span class="hljs-string">&#x27;.&#x27;</span> Name | <span class="hljs-string">&#x27;:&#x27;</span> Name args | args }</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseExpression</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> expression = parseSubExpression(<span class="hljs-number">0</span>, flowContext);
    <span class="hljs-keyword">return</span> expression;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Parse an expression expecting it to be valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseExpectedExpression</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> expression = parseExpression(flowContext);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == expression) raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;expression&gt;&#x27;</span>, token);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> expression;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Return the precedence priority of the operator.</p>
<p>As unary <code>-</code> can’t be distinguished from binary <code>-</code>, unary precedence
isn’t described in this table but in <code>parseSubExpression()</code> itself.</p>
<p>As this function gets hit on every expression it’s been optimized due to
the expensive CompareICStub which took ~8% of the parse time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">binaryPrecedence</span>(<span class="hljs-params">operator</span>) </span>{
    <span class="hljs-keyword">var</span> charCode = operator.charCodeAt(<span class="hljs-number">0</span>)
      , length = operator.length;

    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> === length) {
      <span class="hljs-keyword">switch</span> (charCode) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">94</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>; <span class="hljs-comment">// ^</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">42</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">47</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">37</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// * / %</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">43</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">45</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">9</span>; <span class="hljs-comment">// + -</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">38</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">6</span>; <span class="hljs-comment">// &amp;</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">126</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>; <span class="hljs-comment">// ~</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">124</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>; <span class="hljs-comment">// |</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">60</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">62</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// &lt; &gt;</span>
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">2</span> === length) {
      <span class="hljs-keyword">switch</span> (charCode) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">47</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// //</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">46</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>; <span class="hljs-comment">// ..</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">60</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">62</span>:
            <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;&lt;&lt;&#x27;</span> === operator || <span class="hljs-string">&#x27;&gt;&gt;&#x27;</span> === operator) <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>; <span class="hljs-comment">// &lt;&lt; &gt;&gt;</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// &lt;= &gt;=</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">61</span>: <span class="hljs-keyword">case</span> <span class="hljs-number">126</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// == ~=</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">111</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// or</span>
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">97</span> === charCode &amp;&amp; <span class="hljs-string">&#x27;and&#x27;</span> === operator) <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Implement an operator-precedence parser to handle binary operator
precedence.</p>
<p>We use this algorithm because it’s compact, it’s fast and Lua core uses
the same so we can be sure our expressions are parsed in the same manner
without excessive amounts of tests.</p>
<pre><code>exp ::= (unop exp | primary | prefixexp ) { binop exp }</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseSubExpression</span>(<span class="hljs-params">minPrecedence, flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> operator = token.value</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>The left-hand side in binary operations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      , expression, marker;

    <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>UnaryExpression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isUnary(token)) {
      markLocation();
      next();
      <span class="hljs-keyword">var</span> argument = parseSubExpression(<span class="hljs-number">10</span>, flowContext);
      <span class="hljs-keyword">if</span> (argument == <span class="hljs-literal">null</span>) raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;expression&gt;&#x27;</span>, token);
      expression = finishNode(ast.unaryExpression(operator, argument));
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == expression) {</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>PrimaryExpression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expression = parsePrimaryExpression(flowContext);</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>PrefixExpression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == expression) {
        expression = parsePrefixExpression(flowContext);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>This is not a valid left hand expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == expression) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">var</span> precedence;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      operator = token.value;

      precedence = (Punctuator === token.type || Keyword === token.type) ?
        binaryPrecedence(operator) : <span class="hljs-number">0</span>;

      <span class="hljs-keyword">if</span> (precedence === <span class="hljs-number">0</span> || precedence &lt;= minPrecedence) <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Right-hand precedence operators</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;^&#x27;</span> === operator || <span class="hljs-string">&#x27;..&#x27;</span> === operator) --precedence;
      next();
      <span class="hljs-keyword">var</span> right = parseSubExpression(precedence, flowContext);
      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == right) raiseUnexpectedToken(<span class="hljs-string">&#x27;&lt;expression&gt;&#x27;</span>, token);</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Push in the marker created before the loop to wrap its entirety.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (trackLocations) locations.push(marker);
      expression = finishNode(ast.binaryExpression(operator, expression, right));

    }
    <span class="hljs-keyword">return</span> expression;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <pre><code>prefixexp ::= prefix {suffix}
<span class="hljs-attr">prefix</span> ::= Name | <span class="hljs-string">&#x27;(&#x27;</span> exp <span class="hljs-string">&#x27;)&#x27;</span>
<span class="hljs-attr">suffix</span> ::= <span class="hljs-string">&#x27;[&#x27;</span> exp <span class="hljs-string">&#x27;]&#x27;</span> | <span class="hljs-string">&#x27;.&#x27;</span> Name | <span class="hljs-string">&#x27;:&#x27;</span> Name args | args

<span class="hljs-attr">args</span> ::= <span class="hljs-string">&#x27;(&#x27;</span> [explist] <span class="hljs-string">&#x27;)&#x27;</span> | tableconstructor | <span class="hljs-built_in">String</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parsePrefixExpressionPart</span>(<span class="hljs-params">base, marker, flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> expression, identifier;

    <span class="hljs-keyword">if</span> (Punctuator === token.type) {
      <span class="hljs-keyword">switch</span> (token.value) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[&#x27;</span>:
          pushLocation(marker);
          next();
          expression = parseExpectedExpression(flowContext);
          expect(<span class="hljs-string">&#x27;]&#x27;</span>);
          <span class="hljs-keyword">return</span> finishNode(ast.indexExpression(base, expression));
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;.&#x27;</span>:
          pushLocation(marker);
          next();
          identifier = parseIdentifier();
          <span class="hljs-keyword">return</span> finishNode(ast.memberExpression(base, <span class="hljs-string">&#x27;.&#x27;</span>, identifier));
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;:&#x27;</span>:
          pushLocation(marker);
          next();
          identifier = parseIdentifier();
          base = finishNode(ast.memberExpression(base, <span class="hljs-string">&#x27;:&#x27;</span>, identifier));</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>Once a : is found, this has to be a CallExpression, otherwise
throw an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          pushLocation(marker);
          <span class="hljs-keyword">return</span> parseCallExpression(base, flowContext);
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;(&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;{&#x27;</span>: <span class="hljs-comment">// args</span>
          pushLocation(marker);
          <span class="hljs-keyword">return</span> parseCallExpression(base, flowContext);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringLiteral === token.type) {
      pushLocation(marker);
      <span class="hljs-keyword">return</span> parseCallExpression(base, flowContext);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parsePrefixExpression</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> base, name, marker;

    <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>The prefix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (Identifier === token.type) {
      name = token.value;
      base = parseIdentifier();</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>Set the parent scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (options.scope) attachScope(base, scopeHasName(name));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-function"><span class="hljs-title">consume</span>(<span class="hljs-params"><span class="hljs-string">&#x27;(&#x27;</span></span>)</span>) {
      base = parseExpectedExpression(flowContext);
      expect(<span class="hljs-string">&#x27;)&#x27;</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>The suffix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (;;) {
      <span class="hljs-keyword">var</span> newBase = parsePrefixExpressionPart(base, marker, flowContext);
      <span class="hljs-keyword">if</span> (newBase === <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">break</span>;
      base = newBase;
    }

    <span class="hljs-keyword">return</span> base;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <pre><code>args ::= <span class="hljs-string">&#x27;(&#x27;</span> [explist] <span class="hljs-string">&#x27;)&#x27;</span> | tableconstructor | <span class="hljs-built_in">String</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseCallExpression</span>(<span class="hljs-params">base, flowContext</span>) </span>{
    <span class="hljs-keyword">if</span> (Punctuator === token.type) {
      <span class="hljs-keyword">switch</span> (token.value) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;(&#x27;</span>:
          <span class="hljs-keyword">if</span> (!features.emptyStatement) {
            <span class="hljs-keyword">if</span> (token.line !== previousToken.line)
              raise(<span class="hljs-literal">null</span>, errors.ambiguousSyntax, token.value);
          }
          next();</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>List of expressions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> expressions = [];
          <span class="hljs-keyword">var</span> expression = parseExpression(flowContext);
          <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != expression) expressions.push(expression);
          <span class="hljs-keyword">while</span> (consume(<span class="hljs-string">&#x27;,&#x27;</span>)) {
            expression = parseExpectedExpression(flowContext);
            expressions.push(expression);
          }

          expect(<span class="hljs-string">&#x27;)&#x27;</span>);
          <span class="hljs-keyword">return</span> finishNode(ast.callExpression(base, expressions));

        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;{&#x27;</span>:
          markLocation();
          next();
          <span class="hljs-keyword">var</span> table = parseTableConstructor(flowContext);
          <span class="hljs-keyword">return</span> finishNode(ast.tableCallExpression(base, table));
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringLiteral === token.type) {
      <span class="hljs-keyword">return</span> finishNode(ast.stringCallExpression(base, parsePrimaryExpression(flowContext)));
    }

    raiseUnexpectedToken(<span class="hljs-string">&#x27;function arguments&#x27;</span>, token);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <pre><code>primary ::= <span class="hljs-built_in">String</span> | Numeric | nil | <span class="hljs-literal">true</span> | <span class="hljs-literal">false</span>
     | functiondef | tableconstructor | <span class="hljs-string">&#x27;...&#x27;</span></code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parsePrimaryExpression</span>(<span class="hljs-params">flowContext</span>) </span>{
    <span class="hljs-keyword">var</span> literals = StringLiteral | NumericLiteral | BooleanLiteral | NilLiteral | VarargLiteral
      , value = token.value
      , type = token.type
      , marker;

    <span class="hljs-keyword">if</span> (trackLocations) marker = createLocationMarker();

    <span class="hljs-keyword">if</span> (type === VarargLiteral &amp;&amp; !flowContext.allowVararg) {
      raise(token, errors.cannotUseVararg, token.value);
    }

    <span class="hljs-keyword">if</span> (type &amp; literals) {
      pushLocation(marker);
      <span class="hljs-keyword">var</span> raw = input.slice(token.range[<span class="hljs-number">0</span>], token.range[<span class="hljs-number">1</span>]);
      next();
      <span class="hljs-keyword">return</span> finishNode(ast.literal(type, value, raw));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Keyword === type &amp;&amp; <span class="hljs-string">&#x27;function&#x27;</span> === value) {
      pushLocation(marker);
      next();
      <span class="hljs-keyword">if</span> (options.scope) createScope();
      <span class="hljs-keyword">return</span> parseFunctionDeclaration(<span class="hljs-literal">null</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (consume(<span class="hljs-string">&#x27;{&#x27;</span>)) {
      pushLocation(marker);
      <span class="hljs-keyword">return</span> parseTableConstructor(flowContext);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <h2 id="parser">Parser</h2>

            </div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Export the main parser.</p>
<ul>
<li><code>wait</code> Hold parsing until end() is called. Defaults to false</li>
<li><code>comments</code> Store comments. Defaults to true.</li>
<li><code>scope</code> Track identifier scope. Defaults to false.</li>
<li><code>locations</code> Store location information. Defaults to false.</li>
<li><code>ranges</code> Store the start and end character locations. Defaults to
false.</li>
<li><code>onCreateNode</code> Callback which will be invoked when a syntax node is
created.</li>
<li><code>onCreateScope</code> Callback which will be invoked when a new scope is
created.</li>
<li><code>onDestroyScope</code> Callback which will be invoked when the current scope
is destroyed.</li>
</ul>
<p>Example:</p>
<pre><code><span class="hljs-keyword">var</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;luaparser&#x27;</span>);
parser.parse(<span class="hljs-string">&#x27;i = 0&#x27;</span>);</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-built_in">exports</span>.parse = parse;

  <span class="hljs-keyword">var</span> versionFeatures = {
    <span class="hljs-string">&#x27;5.1&#x27;</span>: {
    },
    <span class="hljs-string">&#x27;5.2&#x27;</span>: {
      <span class="hljs-attr">labels</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">emptyStatement</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">hexEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">skipWhitespaceEscape</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">strictEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">relaxedBreak</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-string">&#x27;5.3&#x27;</span>: {
      <span class="hljs-attr">labels</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">emptyStatement</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">hexEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">skipWhitespaceEscape</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">strictEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">unicodeEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">bitwiseOperators</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">integerDivision</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">relaxedBreak</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-string">&#x27;LuaJIT&#x27;</span>: {</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>XXX: LuaJIT language features may depend on compilation options; may need to
rethink how to handle this. Specifically, there is a LUAJIT_ENABLE_LUA52COMPAT
that removes contextual goto. Maybe add ‘LuaJIT-5.2compat’ as well?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      labels: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">contextualGoto</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">hexEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">skipWhitespaceEscape</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">strictEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">unicodeEscapes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">imaginaryNumbers</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">integerSuffixes</span>: <span class="hljs-literal">true</span>
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(<span class="hljs-params">_input, _options</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;undefined&#x27;</span> === <span class="hljs-keyword">typeof</span> _options &amp;&amp; <span class="hljs-string">&#x27;object&#x27;</span> === <span class="hljs-keyword">typeof</span> _input) {
      _options = _input;
      _input = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">if</span> (!_options) _options = {};

    input = _input || <span class="hljs-string">&#x27;&#x27;</span>;
    options = assign({}, defaultOptions, _options);</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Rewind the lexer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    index = <span class="hljs-number">0</span>;
    line = <span class="hljs-number">1</span>;
    lineStart = <span class="hljs-number">0</span>;
    length = input.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>When tracking identifier scope, initialize with an empty scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    scopes = [[]];
    scopeDepth = <span class="hljs-number">0</span>;
    globals = [];
    locations = [];

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(versionFeatures, options.luaVersion)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(sprintf(<span class="hljs-string">&quot;Lua version &#x27;%1&#x27; not supported&quot;</span>, options.luaVersion));
    }

    features = assign({}, versionFeatures[options.luaVersion]);
    <span class="hljs-keyword">if</span> (options.extendedIdentifiers !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>)
      features.extendedIdentifiers = !!options.extendedIdentifiers;

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(encodingModes, options.encodingMode)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(sprintf(<span class="hljs-string">&quot;Encoding mode &#x27;%1&#x27; not supported&quot;</span>, options.encodingMode));
    }

    encodingMode = encodingModes[options.encodingMode];

    <span class="hljs-keyword">if</span> (options.comments) comments = [];
    <span class="hljs-keyword">if</span> (!options.wait) <span class="hljs-keyword">return</span> end();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Write to the source code buffer without beginning the parse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.write = write;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">_input</span>) </span>{
    input += <span class="hljs-built_in">String</span>(_input);
    length = input.length;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Send an EOF and begin parsing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.end = end;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end</span>(<span class="hljs-params">_input</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;undefined&#x27;</span> !== <span class="hljs-keyword">typeof</span> _input) write(_input);</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Ignore shebangs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (input &amp;&amp; input.substr(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) === <span class="hljs-string">&#x27;#!&#x27;</span>) input = input.replace(<span class="hljs-regexp">/^.*/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">line</span>) </span>{
      <span class="hljs-keyword">return</span> line.replace(<span class="hljs-regexp">/./g</span>, <span class="hljs-string">&#x27; &#x27;</span>);
    });

    length = input.length;
    trackLocations = options.locations || options.ranges;</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Initialize with a lookahead token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lookahead = lex();

    <span class="hljs-keyword">var</span> chunk = parseChunk();
    <span class="hljs-keyword">if</span> (options.comments) chunk.comments = comments;
    <span class="hljs-keyword">if</span> (options.scope) chunk.globals = globals;

    <span class="hljs-comment">/* istanbul ignore if */</span>
    <span class="hljs-keyword">if</span> (locations.length &gt; <span class="hljs-number">0</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;Location tracking failed. This is most likely a bug in luaparse&#x27;</span>);

    <span class="hljs-keyword">return</span> chunk;
  }

}));
<span class="hljs-comment">/* vim: set sw=2 ts=2 et tw=79 : */</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
